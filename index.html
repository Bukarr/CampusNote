<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusNote - Academic Companion</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PWA Meta Tags -->
<meta name="application-name" content="CampusNote">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="CampusNote">
<meta name="description" content="Your academic companion for notes, assignments, and past questions">
<meta name="format-detection" content="telephone=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="msapplication-TileColor" content="#4361ee">
<meta name="msapplication-tap-highlight" content="no">

<!-- Apple Touch Icons -->
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="apple-touch-icon" sizes="152x152" href="icon-192.png">
<link rel="apple-touch-icon" sizes="180x180" href="icon-192.png">
<link rel="apple-touch-icon" sizes="167x167" href="icon-192.png">

<!-- Splash Screens for iOS -->
<link rel="apple-touch-startup-image" href="splash-640x1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
<link rel="apple-touch-startup-image" href="splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
<link rel="apple-touch-startup-image" href="splash-1242x2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">

<!-- Theme Color for Different Browsers -->
<meta name="theme-color" content="#4361ee" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#3a0ca3" media="(prefers-color-scheme: dark)">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #4cc9f0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4bb543;
            --warning-color: #ffcc00;
            --danger-color: #dc3545;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fb;
            color: #333;
            padding-bottom: 80px;
            padding-top: 80px;
        }

        /* Responsive Design */
        .section {
            padding: 20px 15px;
            width: 100%;
            box-sizing: border-box;
        }

        /* Responsive List Items */
        .list-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .list-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .list-item-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #212529;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .list-item-meta {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 12px;
        }

        /* Responsive File Attachments */
        .file-attachment {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }

        .file-name {
            font-weight: 500;
            color: #495057;
            flex: 1;
            min-width: 120px;
            word-break: break-word;
        }

        .file-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Responsive Buttons */
        .btn {
            white-space: nowrap;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
        }

        /* Responsive Grid for Items */
        @media (max-width: 576px) {
            .section {
                padding: 15px 10px;
            }
            
            .list-item {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            .list-item-title {
                font-size: 1rem;
            }
            
            .file-attachment {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .file-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .modal-dialog {
                margin: 10px;
            }
        }

        /* Tablet Styles */
        @media (min-width: 577px) and (max-width: 768px) {
            .section {
                padding: 20px;
            }
            
            .list-item {
                padding: 16px;
            }
        }

        /* Desktop Styles */
        @media (min-width: 769px) {
            .section {
                padding: 30px;
                max-width: 1200px;
                margin: 0 auto;
            }
            
            .list-item {
                padding: 20px;
            }
        }

        /* Empty State Responsive */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            color: #dee2e6;
        }

        /* Modal Responsive */
        @media (max-width: 576px) {
            .modal-content {
                margin: 10px;
                border-radius: 8px;
            }
            
            .modal-header, 
            .modal-body, 
            .modal-footer {
                padding: 15px;
            }
        }

        /* File Preview Responsive */
        .file-preview-container {
            margin-top: 10px;
        }

        .file-preview-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }

        /* Ensure forms are responsive */
        .form-control {
            width: 100%;
            box-sizing: border-box;
        }

        /* Responsive action buttons in list items */
        .list-item-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        @media (max-width: 576px) {
            .list-item-actions {
                justify-content: space-between;
            }
            
            .list-item-actions .btn {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
        }
                
        /* Top Navigation */
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .navbar-brand i {
            color: var(--accent-color);
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            z-index: 1000;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .bottom-nav-content {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
        }
        
        .bottom-nav-item {
            background: none;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
            color: #6c757d;
            padding: 5px 8px;
            flex: 1;
            transition: all 0.3s ease;
            border-radius: 10px;
        }
        
        .bottom-nav-item.active {
            color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .bottom-nav-item i {
            font-size: 1.3rem;
            margin-bottom: 4px;
        }
        
        /* Sections */
        .section {
            display: none;
            padding: 20px 15px; /* Increased padding */
            animation: fadeIn 0.3s ease;
            margin-bottom: 30px; /* Added margin bottom */
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px 20px;
            border-radius: 15px;
            margin-bottom: 30px; /* Increased margin */
            text-align: center;
        }
        
        /* User menu styling */
        #userMenu .nav-link {
            padding: 0.5rem;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        #userMenu .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        #userMenu .dropdown-toggle::after {
            display: none; /* Hide the dropdown arrow */
        }

        #userMenu .fa-user,
        #userMenu .fa-user-circle {
            font-size: 1.2rem;
        }

        /* Dropdown menu styling */
        .dropdown-header {
            font-weight: 600;
            color: #495057;
        }

        .dropdown-item {
            padding: 0.5rem 1rem;
        }

        .dropdown-item i {
            width: 16px;
            text-align: center;
        }
        
        /* File attachment styles */
        .file-attachment {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 8px;
        }

        .file-name {
            font-weight: 500;
            color: #495057;
        }

        .file-preview-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 8px;
        }

        /* Download button styles */
        .btn-outline-success {
            border-color: #198754;
            color: #198754;
        }

        .btn-outline-success:hover {
            background-color: #198754;
            color: white;
        }
        
        /* Cards */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px; /* Increased margin */
        }
        
        .card-header {
            background: white;
            border-bottom: 1px solid #eaeaea;
            font-weight: 600;
            padding: 15px 20px;
        }
        
        .card-body {
            padding: 20px;
        }
        
        /* Feature Icons */
        .feature-icon {
            width: 60px;
            height: 60px;
            background: rgba(67, 97, 238, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: var(--primary-color);
            font-size: 1.5rem;
        }
        
        /* Buttons */
        .btn {
            border-radius: 8px;
            font-weight: 500;
            padding: 10px 20px;
        }
        
        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        /* Auth Forms */
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        /* User Avatar */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            padding: 30px;
        }
        
        /* Chat Styles - WhatsApp-like */
        .chat-container {
            display: flex;
            height: calc(100vh - 200px);
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .chat-sidebar {
            width: 30%;
            border-right: 1px solid #eaeaea;
            display: flex;
            flex-direction: column;
        }
        
        .chat-sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #eaeaea;
            background: #f8f9fa;
        }
        
        .chat-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .chat-item:hover {
            background-color: #f8f9fa;
        }
        
        .chat-item.active {
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
        }
        
        .chat-info {
            flex: 1;
        }
        
        .chat-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .chat-preview {
            font-size: 0.8rem;
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-meta {
            text-align: right;
            font-size: 0.7rem;
            color: #6c757d;
        }
        
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #eaeaea;
            background: #f8f9fa;
            display: flex;
            align-items: center;
        }
        
        .chat-back-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.2rem;
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f0f2f5;
        }
        
        .message {
            display: flex;
            margin-bottom: 15px;
            position: relative;
        }
        
        .own-message {
            justify-content: flex-end;
        }
        
        .other-message {
            justify-content: flex-start;
        }
        
        .message-content {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 7.5px;
            word-wrap: break-word;
            position: relative;
        }
        
        .own-message .message-content {
            background: #dcf8c6;
            color: #000;
            border-top-right-radius: 0;
        }
        
        .other-message .message-content {
            background: white;
            color: #333;
            border-top-left-radius: 0;
        }
        
        .message-time {
            font-size: 0.7rem;
            color: #6c757d;
            text-align: right;
            margin-top: 3px;
        }
        
        .message-date {
            text-align: center;
            margin: 15px 0;
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #eaeaea;
            background: white;
        }
        
        .chat-input-container {
            display: flex;
            align-items: flex-end;
        }
        
        .chat-input {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            padding: 10px 15px;
            resize: none;
            max-height: 100px;
            min-height: 40px;
            font-family: inherit;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .chat-send-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        
        .chat-send-btn:hover {
            background: var(--secondary-color);
        }
        
        .chat-send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .user-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
            margin-left: auto;
        }
        
        .user-status.online {
            background: var(--success-color);
        }
        
        /* List Items */
        .list-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }
        
        .list-item:hover {
            background-color: #f8f9fa;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .list-item-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .list-item-meta {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        /* File Upload Styles */
        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .file-upload-area:hover {
            border-color: var(--primary-color);
            background: #e9ecef;
        }
        
        .file-upload-area i {
            font-size: 2rem;
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-preview {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .file-preview-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 5px 0;
        }
        
        .file-preview-item .file-name {
            flex: 1;
        }
        
        .file-preview-item .file-remove {
            color: var(--danger-color);
            cursor: pointer;
        }
        
        /* Badges */
        .badge {
            border-radius: 20px;
            padding: 5px 10px;
            font-size: 0.7rem;
        }
        
        /* Hide navbar toggler */
        .navbar-toggler, .navbar-collapse {
            display: none !important;
        }
        
        .navbar-nav {
            flex-direction: row !important;
            align-items: center;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Real-time indicators */
        .real-time-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .new-item-indicator {
            background: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 8px;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Loading and Progress Indicators */
        .progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .progress-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .progress-text {
            margin-top: 10px;
            font-weight: 500;
        }

        .button-loading {
            position: relative;
            pointer-events: none;
        }

        .button-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: button-loading-spinner 1s ease infinite;
        }

        @keyframes button-loading-spinner {
            from {
                transform: rotate(0turn);
            }

            to {
                transform: rotate(1turn);
            }
        }

        /* Profile Picture Upload */
        .profile-picture-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .profile-picture {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
        }

        .profile-picture-upload {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Search Bar Styles */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            padding-right: 40px;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .search-result-item:hover {
            background-color: #f8f9fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .search-result-meta {
            font-size: 0.8rem;
            color: #6c757d;
        }

        /* Contribution Badges */
        .contribution-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
        }

        .contribution-badge {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .badge-level-1 { background: linear-gradient(135deg, #6c757d, #495057); }
        .badge-level-2 { background: linear-gradient(135deg, #28a745, #20c997); }
        .badge-level-3 { background: linear-gradient(135deg, #ffc107, #fd7e14); }
        .badge-level-4 { background: linear-gradient(135deg, #dc3545, #e83e8c); }
        .badge-level-5 { background: linear-gradient(135deg, #6f42c1, #e83e8c); }

        /* Mobile Chat Styles */
        @media (max-width: 768px) {
            .chat-sidebar {
                width: 100%;
            }
            
            .chat-main {
                display: none;
                width: 100%;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 1050;
                background: white;
                border-radius: 0;
            }
            
            .chat-main.active {
                display: flex;
            }
            
            .chat-back-btn {
                display: block;
            }
            
            .chat-container {
                height: calc(100vh - 150px);
            }
            
            .chat-messages {
                height: calc(100vh - 130px);
            }
        }

        /* File Preview Modal */
        .file-preview-modal .modal-dialog {
            max-width: 95%;
            height: 95vh;
        }

        .file-preview-modal .modal-content {
            height: 100%;
        }

        .file-preview-modal .modal-body {
            height: calc(100% - 120px);
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-preview-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-preview-content iframe,
        .file-preview-content img {
            max-width: 100%;
            max-height: 100%;
            border: none;
        }

        .file-preview-content .unsupported-file {
            text-align: center;
            padding: 40px;
        }
        .user-link {
    color: var(--primary-color);
    cursor: pointer;
    text-decoration: none;
    font-weight: 500;
}
.user-link:hover {
    text-decoration: underline;
}
.mobile-back-btn {
    transition: all 0.3s ease;
}
.mobile-back-btn:active {
    transform: scale(0.95);
}
.note-description {
    border-left: 3px solid var(--primary-color);
}
.user-initials {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 2rem;
    margin: 0 auto;
}
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-book me-2"></i>CampusNote <span class="real-time-indicator"></span>
            </a>
            <div class="nav-item dropdown" id="userMenu">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-user" id="userIcon"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" id="userDropdownMenu">
                    <!-- Unauthenticated state -->
                    <div id="unauthenticatedMenu">
                        <li><a class="dropdown-item" href="#" id="dropdownLoginBtn"><i class="fas fa-sign-in-alt me-2"></i>Login</a></li>
                        <li><a class="dropdown-item" href="#" id="dropdownSignupBtn"><i class="fas fa-user-plus me-2"></i>Sign Up</a></li>
                    </div>
                    
                    <!-- Authenticated state -->
                    <div id="authenticatedMenu" style="display: none;">
                        <li><span class="dropdown-header"><i class="fas fa-user me-2"></i><span id="dropdownUserName">User</span></span></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" data-section="profile"><i class="fas fa-user-edit me-2"></i>Profile</a></li>
                        <li><a class="dropdown-item" href="#" id="dropdownLogoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                    </div>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Authentication Section -->
        <div id="auth-section" class="section active">
            <div class="container">
                <div class="auth-container" id="loginForm">
                    <h3 class="text-center mb-4">Login to CampusNote</h3>
                    <form id="loginFormElement">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="loginBtn">
                                <span id="loginBtnText">Login</span>
                            </button>
                        </div>
                    </form>
                    <div class="text-center mt-3">
                        <p>Don't have an account? <a href="#" id="showSignupFromLogin">Sign up</a></p>
                    </div>
                    <div id="loginError" class="alert alert-danger mt-3" style="display: none;"></div>
                </div>
                
                <div class="auth-container" id="signupForm" style="display: none;">
                    <h3 class="text-center mb-4">Create Account</h3>
                    <form id="signupFormElement">
                        <div class="mb-3">
                            <label for="signupName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="signupName" required>
                        </div>
                        <div class="mb-3">
                            <label for="signupEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="signupEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="signupPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="signupPassword" required minlength="6">
                        </div>
                        <div class="mb-3">
                            <label for="signupLevel" class="form-label">Academic Level</label>
                            <select class="form-select" id="signupLevel" required>
                                <option value="">Select Level</option>
                                <option value="100L">100 Level</option>
                                <option value="200L">200 Level</option>
                                <option value="300L">300 Level</option>
                                <option value="400L">400 Level</option>
                                <option value="500L">500 Level</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="signupDepartment" class="form-label">Department</label>
                            <input type="text" class="form-control" id="signupDepartment" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="signupBtn">
                                <span id="signupBtnText">Sign Up</span>
                            </button>
                        </div>
                    </form>
                    <div class="text-center mt-3">
                        <p>Already have an account? <a href="#" id="showLoginFromSignup">Login</a></p>
                    </div>
                    <div id="signupError" class="alert alert-danger mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section main-section pt-5 pt-md-3 pb-5">
            <div class="hero-section">
                <div class="container text-center">
                    <h1 class="display-5 fw-bold">Welcome to CampusNote <span class="real-time-indicator"></span></h1>
                    <p class="lead">Your academic companion for notes, assignments, and past questions</p>
                    <p class="welcome-user" id="welcomeUser">Hello, Student!</p>
                </div>
            </div>
            
            <div class="container">
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 text-center">
                            <div class="card-body">
                                <div class="feature-icon">
                                    <i class="fas fa-sticky-note"></i>
                                </div>
                                <h5 class="card-title">Lecture Notes</h5>
                                <p class="card-text">Access and share summarized notes from your classes</p>
                                <a href="#" class="btn btn-primary" data-section="notes">View Notes</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 text-center">
                            <div class="card-body">
                                <div class="feature-icon">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <h5 class="card-title">Assignments</h5>
                                <p class="card-text">Track your assignments and submission deadlines</p>
                                <a href="#" class="btn btn-primary" data-section="assignments">View Assignments</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 text-center">
                            <div class="card-body">
                                <div class="feature-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <h5 class="card-title">Past Questions</h5>
                                <p class="card-text">Prepare for exams with past questions and answers</p>
                                <a href="#" class="btn btn-primary" data-section="past-questions">View Past Questions</a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Recent Notes <span class="real-time-indicator"></span></span>
                                <a href="#" data-section="notes" class="btn btn-sm btn-primary">View All</a>
                            </div>
                            <div class="card-body">
                                <div id="recentNotesContent">
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Upcoming Assignments <span class="real-time-indicator"></span></span>
                            </div>
                            <div class="card-body">
                                <div id="upcomingAssignmentsContent">
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div id="notes" class="section main-section pt-5 pt-md-3 pb-5">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Lecture Notes <span class="real-time-indicator"></span></h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                        <i class="fas fa-plus me-2"></i>Add Note
                    </button>
                </div>

                <!-- Search Bar for Notes -->
                <div class="search-container mb-4">
                    <input type="text" class="form-control search-input" id="notesSearch" placeholder="Search notes by title or course...">
                    <i class="fas fa-search search-icon"></i>
                    <div class="search-results" id="notesSearchResults"></div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div id="notesContent">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assignments Section -->
        <div id="assignments" class="section main-section pt-5 pt-md-3 pb-5">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Assignments <span class="real-time-indicator"></span></h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAssignmentModal">
                        <i class="fas fa-plus me-2"></i>Add Assignment
                    </button>
                </div>

                <!-- Search Bar for Assignments -->
                <div class="search-container mb-4">
                    <input type="text" class="form-control search-input" id="assignmentsSearch" placeholder="Search assignments by title or course...">
                    <i class="fas fa-search search-icon"></i>
                    <div class="search-results" id="assignmentsSearchResults"></div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div id="assignmentsContent">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Past Questions Section -->
        <div id="past-questions" class="section main-section pt-5 pt-md-3 pb-5">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Past Questions <span class="real-time-indicator"></span></h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPastQuestionModal">
                        <i class="fas fa-plus me-2"></i>Add Past Question
                    </button>
                </div>

                <!-- Search Bar for Past Questions -->
                <div class="search-container mb-4">
                    <input type="text" class="form-control search-input" id="pastQuestionsSearch" placeholder="Search past questions by title, course, or year...">
                    <i class="fas fa-search search-icon"></i>
                    <div class="search-results" id="pastQuestionsSearchResults"></div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div id="pastQuestionsContent">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Section - WhatsApp Style -->
        <div id="chat" class="section main-section pt-5 pt-md-3 pb-5">
            <div class="container">
                <h2 class="mb-4">Chat <span class="real-time-indicator"></span></h2>
                <div class="chat-container">
                    <!-- Chat Sidebar -->
                    <div class="chat-sidebar">
                        <div class="chat-sidebar-header">
                            <h5 class="mb-0">Chats</h5>
                        </div>
                        <div class="chat-list" id="chatUserList">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Main Area -->
                    <div class="chat-main" id="chatMain">
                        <div class="chat-header">
                            <button class="chat-back-btn" id="chatBackBtn">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <div class="chat-avatar" id="chatHeaderAvatar">
                                <!-- Avatar will be inserted here -->
                            </div>
                            <div class="chat-info ms-3">
                                <div class="chat-name" id="chatHeaderName">Select a user to chat</div>
                                <div class="chat-preview" id="chatHeaderStatus">Online</div>
                            </div>
                        </div>
                        
                        <div class="chat-messages" id="chatMessages">
                            <div class="empty-state">
                                <i class="fas fa-comments"></i>
                                <p>Select a user to start chatting</p>
                            </div>
                        </div>
                        
                        <div class="chat-input-area">
                            <div class="chat-input-container">
                                <textarea class="chat-input" id="messageInput" placeholder="Type a message..." rows="1" disabled></textarea>
                                <button class="chat-send-btn" id="sendMessageBtn" disabled>
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profile" class="section main-section pt-5 pt-md-3 pb-5">
            <div class="container">
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="profile-picture-container">
                                    <img src="" alt="Profile Picture" class="profile-picture" id="profilePicture">
                                    <div class="profile-picture-upload" id="profilePictureUpload">
                                        <i class="fas fa-camera"></i>
                                        <input type="file" id="profilePictureInput" class="d-none" accept="image/*">
                                    </div>
                                </div>
                                <h4 id="profileName">User Name</h4>
                                <p class="text-muted" id="profileLevel">Level</p>
                                <p class="text-muted" id="profileDepartment">Department</p>
                                <p class="text-muted" id="profileEmail">Email</p>
                                
                                <!-- Contribution Badges -->
                                <div class="contribution-badges" id="contributionBadges">
                                    <!-- Badges will be dynamically inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">My Contributions</h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <h3 id="myNotesCount">0</h3>
                                        <p class="text-muted">Notes</p>
                                    </div>
                                    <div class="col-4">
                                        <h3 id="myAssignmentsCount">0</h3>
                                        <p class="text-muted">Assignments</p>
                                    </div>
                                    <div class="col-4">
                                        <h3 id="myPastQuestionsCount">0</h3>
                                        <p class="text-muted">Past Questions</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5 class="mb-0">Edit Profile</h5>
                            </div>
                            <div class="card-body">
                                <form id="profileForm">
                                    <div class="mb-3">
                                        <label for="editName" class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="editName">
                                    </div>
                                    <div class="mb-3">
                                        <label for="editLevel" class="form-label">Academic Level</label>
                                        <select class="form-select" id="editLevel">
                                            <option value="100L">100 Level</option>
                                            <option value="200L">200 Level</option>
                                            <option value="300L">300 Level</option>
                                            <option value="400L">400 Level</option>
                                            <option value="500L">500 Level</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editDepartment" class="form-label">Department</label>
                                        <input type="text" class="form-control" id="editDepartment">
                                    </div>
                                    <button type="submit" class="btn btn-primary" id="updateProfileBtn">
                                        <span id="updateProfileBtnText">Update Profile</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="bottom-nav-content">
            <button class="bottom-nav-item active" data-section="dashboard">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="bottom-nav-item" data-section="notes">
                <i class="fas fa-sticky-note"></i>
                <span>Notes</span>
            </button>
            <button class="bottom-nav-item" data-section="assignments">
                <i class="fas fa-tasks"></i>
                <span>Tasks</span>
            </button>
            <button class="bottom-nav-item" data-section="past-questions">
                <i class="fas fa-file-alt"></i>
                <span>Questions</span>
            </button>
            <button class="bottom-nav-item" data-section="chat">
                <i class="fas fa-comments"></i>
                <span>Chat</span>
            </button>
            <button class="bottom-nav-item" data-section="profile">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </button>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div class="modal fade" id="addNoteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Note</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addNoteForm">
                        <div class="mb-3">
                            <label for="noteTitle" class="form-label">Note Title *</label>
                            <input type="text" class="form-control" id="noteTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="noteCourse" class="form-label">Course *</label>
                            <input type="text" class="form-control" id="noteCourse" required>
                        </div>
<div class="mb-3">
    <label for="noteDescription" class="form-label">Description/Post</label>
    <textarea class="form-control" id="noteDescription" rows="3" placeholder="Add a description or post about this note... (Optional)"></textarea>
    <div class="form-text">This description will be visible to other users before downloading</div>
</div>
                        <div class="mb-3">
                            <label for="noteFiles" class="form-label">Upload Note File *</label>
                            <input type="file" class="form-control" id="noteFiles" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png" required>
                            <div class="form-text">Supported formats: PDF, Word, Text, Images (Max: 10MB)</div>
                        </div>
                        <div id="noteFilesPreview" class="file-preview-container"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNoteBtn">
                        <span id="saveNoteBtnText">Save Note</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Assignment Modal -->
    <div class="modal fade" id="addAssignmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Assignment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addAssignmentForm">
                        <div class="mb-3">
                            <label for="assignmentTitle" class="form-label">Assignment Title *</label>
                            <input type="text" class="form-control" id="assignmentTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="assignmentCourse" class="form-label">Course *</label>
                            <input type="text" class="form-control" id="assignmentCourse" required>
                        </div>
                        <div class="mb-3">
                            <label for="assignmentDueDate" class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="assignmentDueDate">
                        </div>
                        <!-- Inside #addAssignmentForm, after due date field -->
<div class="mb-3">
    <label for="assignmentDescription" class="form-label">Description/Post</label>
    <textarea class="form-control" id="assignmentDescription" rows="3" placeholder="Add a description about this assignment... (Optional)"></textarea>
</div>
                        <div class="mb-3">
                            <label for="assignmentFiles" class="form-label">Upload Assignment File *</label>
                            <input type="file" class="form-control" id="assignmentFiles" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png" required>
                            <div class="form-text">Supported formats: PDF, Word, Text, Images (Max: 10MB)</div>
                        </div>
                        <div id="assignmentFilesPreview" class="file-preview-container"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveAssignmentBtn">
                        <span id="saveAssignmentBtnText">Save Assignment</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Past Question Modal -->
    <div class="modal fade" id="addPastQuestionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Past Question</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addPastQuestionForm">
                        <div class="mb-3">
                            <label for="pastQuestionTitle" class="form-label">Title *</label>
                            <input type="text" class="form-control" id="pastQuestionTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="pastQuestionCourse" class="form-label">Course *</label>
                            <input type="text" class="form-control" id="pastQuestionCourse" required>
                        </div>
                        <div class="mb-3">
                            <label for="pastQuestionYear" class="form-label">Year *</label>
                            <input type="number" class="form-control" id="pastQuestionYear" min="2000" max="2030" required>
                        </div>
                        <!-- Inside #addPastQuestionForm, after year field -->
<div class="mb-3">
    <label for="pastQuestionDescription" class="form-label">Description/Post</label>
    <textarea class="form-control" id="pastQuestionDescription" rows="3" placeholder="Add a description about this past question... (Optional)"></textarea>
</div>
                        <div class="mb-3">
                            <label for="pastQuestionFile" class="form-label">Upload Past Question File *</label>
                            <input type="file" class="form-control" id="pastQuestionFile" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                            <div class="form-text">Supported formats: PDF, Word, Images (Max: 10MB)</div>
                        </div>
                        <div id="pastQuestionFilePreview" class="file-preview-container"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="savePastQuestionBtn">
                        <span id="savePastQuestionBtnText">Save Past Question</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div class="modal fade file-preview-modal" id="filePreviewModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="filePreviewTitle">File Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="file-preview-content" id="filePreviewContent">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading preview...</span>
                        </div>
                        <p class="mt-2">Loading preview...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="downloadPreviewFile">
                        <i class="fas fa-download me-2"></i>Download
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Overlay -->
    <div class="progress-overlay" id="progressOverlay" style="display: none;">
        <div class="progress-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="progress-text" id="progressText">Processing...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        const supabaseUrl = 'https://nijpmtwihccpaqsiirva.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5panBtdHdpaGNjcGFxc2lpcnZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNTI3MjQsImV4cCI6MjA3NDcyODcyNH0.aepDRx4Ew0zHdS6HAOUi1C8NXdMXvX5cf5ScQyfrvCM';
        const supabase = createClient(supabaseUrl, supabaseKey)

        // Global variables
        let currentUser = null;
        let currentChatUser = null;
        let chatSubscription = null;
        let notesSubscription = null;
        let assignmentsSubscription = null;
        let pastQuestionsSubscription = null;
        let displayedMessageIds = new Set();
        let lastMessageTimestamp = 0;
        let allNotes = [];
        let allAssignments = [];
        let allPastQuestions = [];
        let currentPreviewFile = null;
        let navigationHistory = [];
let isBackNavigation = false;
let currentViewedUser = null;

        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 CampusNote - Real-time Academic Platform');
            initializeApp();
            setupEventListeners();
            checkAuthState();
            setupFileUploadHandlers();
            setupSearchFunctionality();
            
         // Initialize PWA
            setupBackNavigation();
    initializePWA();
    setupNetworkDetection();
});

        function initializeApp() {
            console.log('🔧 Initializing real-time app');
        }

        function setupEventListeners() {
            console.log('🔧 Setting up event listeners');

            // Switch between login and signup forms (header links)
            const showLoginLink = document.getElementById('showLogin');
            const showSignupLink = document.getElementById('showSignup');
            
            if (showLoginLink) {
                showLoginLink.addEventListener('click', showLoginForm);
                console.log('✅ Show login link listener added');
            }
            
            if (showSignupLink) {
                showSignupLink.addEventListener('click', showSignupForm);
                console.log('✅ Show signup link listener added');
            }
            
            // In-form links (Don't have account? / Already have account?)
            const showSignupFromLogin = document.getElementById('showSignupFromLogin');
            const showLoginFromSignup = document.getElementById('showLoginFromSignup');
            
            if (showSignupFromLogin) {
                showSignupFromLogin.addEventListener('click', showSignupForm);
                console.log('✅ Show signup from login link listener added');
            }
            
            if (showLoginFromSignup) {
                showLoginFromSignup.addEventListener('click', showLoginForm);
                console.log('✅ Show login from signup link listener added');
            }
            
            // Login form submission
            const loginForm = document.getElementById('loginFormElement');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
                console.log('✅ Login form event listener added');
            }
            
            // Signup form submission
            const signupForm = document.getElementById('signupFormElement');
            if (signupForm) {
                signupForm.addEventListener('submit', handleSignup);
                console.log('✅ Signup form event listener added');
            }
            
            // Use event delegation for dynamic elements
            document.addEventListener('click', function(e) {
                console.log('🎯 Click event on:', e.target);
                
                // Handle dropdown login
                if (e.target.id === 'dropdownLoginBtn' || e.target.closest('#dropdownLoginBtn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🔄 Login clicked from dropdown');
                    showLoginForm();
                    return;
                }
                
                // Handle dropdown signup
                if (e.target.id === 'dropdownSignupBtn' || e.target.closest('#dropdownSignupBtn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🔄 Signup clicked from dropdown');
                    showSignupForm();
                    return;
                }
                
                // Handle dropdown logout
                if (e.target.id === 'dropdownLogoutBtn' || e.target.closest('#dropdownLogoutBtn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🔄 Logout clicked from dropdown');
                    handleLogout();
                    return;
                }
                
                // Handle profile navigation
                if (e.target.closest('[data-section="profile"]')) {
                    e.preventDefault();
                    e.stopPropagation();
                    switchSection('profile');
                    const dropdown = bootstrap.Dropdown.getInstance(document.querySelector('#userMenu .dropdown-toggle'));
                    if (dropdown) dropdown.hide();
                    return;
                }
            });

            // Direct event listeners as backup
            setTimeout(() => {
                const dropdownLoginBtn = document.getElementById('dropdownLoginBtn');
                const dropdownSignupBtn = document.getElementById('dropdownSignupBtn');
                const dropdownLogoutBtn = document.getElementById('dropdownLogoutBtn');
                
                if (dropdownLoginBtn) {
                    dropdownLoginBtn.onclick = function(e) {
                        e.preventDefault();
                        console.log('🔄 Login clicked (direct)');
                        showLoginForm();
                    };
                }
                
                if (dropdownSignupBtn) {
                    dropdownSignupBtn.onclick = function(e) {
                        e.preventDefault();
                        console.log('🔄 Signup clicked (direct)');
                        showSignupForm();
                    };
                }
                
                if (dropdownLogoutBtn) {
                    dropdownLogoutBtn.onclick = function(e) {
                        e.preventDefault();
                        console.log('🔄 Logout clicked (direct)');
                        handleLogout();
                    };
                }
            }, 500);

            // Bottom navigation
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    if (!currentUser) {
                        alert('Please log in to access this section');
                        showLoginForm();
                        return;
                    }
                    const section = this.getAttribute('data-section');
                    console.log('📱 Switching to section:', section);
                    switchSection(section);
                    updateBottomNav(this);
                });
            });

            // Modal forms
            const saveNoteBtn = document.getElementById('saveNoteBtn');
            const saveAssignmentBtn = document.getElementById('saveAssignmentBtn');
            const savePastQuestionBtn = document.getElementById('savePastQuestionBtn');
            
            if (saveNoteBtn) saveNoteBtn.addEventListener('click', saveNote);
            if (saveAssignmentBtn) saveAssignmentBtn.addEventListener('click', saveAssignment);
            if (savePastQuestionBtn) savePastQuestionBtn.addEventListener('click', savePastQuestion);
            
            // Profile form
            const profileForm = document.getElementById('profileForm');
            if (profileForm) profileForm.addEventListener('submit', updateProfile);
            
            // Chat
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const messageInput = document.getElementById('messageInput');
            const chatBackBtn = document.getElementById('chatBackBtn');
            
            if (sendMessageBtn) sendMessageBtn.addEventListener('click', sendMessage);
            if (messageInput) {
                messageInput.addEventListener('input', autoResizeTextarea);
                messageInput.addEventListener('keydown', handleChatInputKeydown);
            }
            if (chatBackBtn) chatBackBtn.addEventListener('click', showChatUserList);

            // Profile picture upload
            const profilePictureUpload = document.getElementById('profilePictureUpload');
            const profilePictureInput = document.getElementById('profilePictureInput');
            
            if (profilePictureUpload) {
                profilePictureUpload.addEventListener('click', function() {
                    profilePictureInput.click();
                });
            }
            
            if (profilePictureInput) {
                profilePictureInput.addEventListener('change', uploadProfilePicture);
            }

            // File preview download button
            const downloadPreviewFile = document.getElementById('downloadPreviewFile');
            if (downloadPreviewFile) {
                downloadPreviewFile.addEventListener('click', function() {
                    if (currentPreviewFile) {
                        downloadFile(currentPreviewFile.url, currentPreviewFile.name);
                    }
                });
            }
            
            // Section navigation from cards
            document.querySelectorAll('[data-section]').forEach(link => {
                if (!link.classList.contains('bottom-nav-item')) {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const section = this.getAttribute('data-section');
                        console.log('🔗 Navigation to:', section);
                        switchSection(section);
                        updateBottomNavForSection(section);
                    });
                }
            });
            
            console.log('✅ Event listeners setup complete');
        }

        // Setup search functionality
        function setupSearchFunctionality() {
            // Notes search
            const notesSearch = document.getElementById('notesSearch');
            if (notesSearch) {
                notesSearch.addEventListener('input', function() {
                    searchNotes(this.value);
                });
                
                // Hide search results when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.search-container')) {
                        const results = document.getElementById('notesSearchResults');
                        if (results) results.style.display = 'none';
                    }
                });
            }

            // Assignments search
            const assignmentsSearch = document.getElementById('assignmentsSearch');
            if (assignmentsSearch) {
                assignmentsSearch.addEventListener('input', function() {
                    searchAssignments(this.value);
                });
                
                // Hide search results when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.search-container')) {
                        const results = document.getElementById('assignmentsSearchResults');
                        if (results) results.style.display = 'none';
                    }
                });
            }

            // Past questions search
            const pastQuestionsSearch = document.getElementById('pastQuestionsSearch');
            if (pastQuestionsSearch) {
                pastQuestionsSearch.addEventListener('input', function() {
                    searchPastQuestions(this.value);
                });
                
                // Hide search results when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.search-container')) {
                        const results = document.getElementById('pastQuestionsSearchResults');
                        if (results) results.style.display = 'none';
                    }
                });
            }
        }

        // Search functions
        function searchNotes(query) {
            const resultsContainer = document.getElementById('notesSearchResults');
            if (!resultsContainer) return;
            
            if (!query.trim()) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const filteredNotes = allNotes.filter(note => 
                note.title.toLowerCase().includes(query.toLowerCase()) ||
                note.course.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filteredNotes.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No notes found</div>';
            } else {
                resultsContainer.innerHTML = filteredNotes.map(note => `
                    <div class="search-result-item" onclick="selectSearchResult('notes', '${note.id}')">
                        <div class="search-result-title">${escapeHtml(note.title)}</div>
                        <div class="search-result-meta">${escapeHtml(note.course)} • ${formatDate(note.created_at)}</div>
                    </div>
                `).join('');
            }
            
            resultsContainer.style.display = 'block';
        }

        function searchAssignments(query) {
            const resultsContainer = document.getElementById('assignmentsSearchResults');
            if (!resultsContainer) return;
            
            if (!query.trim()) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const filteredAssignments = allAssignments.filter(assignment => 
                assignment.title.toLowerCase().includes(query.toLowerCase()) ||
                assignment.course.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filteredAssignments.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No assignments found</div>';
            } else {
                resultsContainer.innerHTML = filteredAssignments.map(assignment => `
                    <div class="search-result-item" onclick="selectSearchResult('assignments', '${assignment.id}')">
                        <div class="search-result-title">${escapeHtml(assignment.title)}</div>
                        <div class="search-result-meta">${escapeHtml(assignment.course)} • Due: ${formatDate(assignment.due_date)}</div>
                    </div>
                `).join('');
            }
            
            resultsContainer.style.display = 'block';
        }

        function searchPastQuestions(query) {
            const resultsContainer = document.getElementById('pastQuestionsSearchResults');
            if (!resultsContainer) return;
            
            if (!query.trim()) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const filteredPastQuestions = allPastQuestions.filter(pq => 
                pq.title.toLowerCase().includes(query.toLowerCase()) ||
                pq.course.toLowerCase().includes(query.toLowerCase()) ||
                pq.year.toString().includes(query)
            );
            
            if (filteredPastQuestions.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No past questions found</div>';
            } else {
                resultsContainer.innerHTML = filteredPastQuestions.map(pq => `
                    <div class="search-result-item" onclick="selectSearchResult('past-questions', '${pq.id}')">
                        <div class="search-result-title">${escapeHtml(pq.title)}</div>
                        <div class="search-result-meta">${escapeHtml(pq.course)} • ${pq.year}</div>
                    </div>
                `).join('');
            }
            
            resultsContainer.style.display = 'block';
        }

        // Handle search result selection
        window.selectSearchResult = function(section, itemId) {
            // Hide search results
            const resultsContainers = document.querySelectorAll('.search-results');
            resultsContainers.forEach(container => {
                container.style.display = 'none';
            });
            
            // Clear search inputs
            const searchInputs = document.querySelectorAll('.search-input');
            searchInputs.forEach(input => {
                input.value = '';
            });
            
            // Navigate to the section
            switchSection(section);
            
            // Find and highlight the specific item
            setTimeout(() => {
                const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
                if (itemElement) {
                    // Scroll to the item
                    itemElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Add highlight effect
                    itemElement.style.backgroundColor = 'rgba(67, 97, 238, 0.1)';
                    itemElement.style.border = '2px solid #4361ee';
                    
                    // Remove highlight after 3 seconds
                    setTimeout(() => {
                        itemElement.style.backgroundColor = '';
                        itemElement.style.border = '';
                    }, 3000);
                }
            }, 500);
        };

        async function checkAuthState() {
            console.log('🔐 Checking authentication state');
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('❌ Session error:', error);
                    showUnauthenticatedUI();
                    return;
                }
                
                if (session) {
                    console.log('✅ User authenticated:', session.user.email);
                    currentUser = session.user;
                    await loadUserProfile();
                    showAuthenticatedUI();
                    loadDashboardData();
                    setupRealtimeSubscriptions();
                } else {
                    console.log('❌ No active session');
                    showUnauthenticatedUI();
                }
            } catch (error) {
                console.error('Auth check error:', error);
                showUnauthenticatedUI();
            }
        }

        // Authentication functions
        function showLoginForm(e) { 
            if (e) e.preventDefault(); 
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            switchSection('auth-section');
        }

        function showSignupForm(e) { 
            if (e) e.preventDefault(); 
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            switchSection('auth-section');
        }

        async function handleLogin(e) {
            e.preventDefault();
            console.log('🔐 Login attempt started');
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            
            if (!email || !password) {
                if (errorDiv) {
                    errorDiv.textContent = 'Please enter both email and password';
                    errorDiv.style.display = 'block';
                }
                return;
            }
            
            try {
                // Show loading state
                setButtonLoading(loginBtn, loginBtnText, true);
                
                console.log('📧 Attempting login for:', email);
                const { data, error } = await supabase.auth.signInWithPassword({ 
                    email: email, 
                    password: password 
                });
                
                if (error) {
                    console.error('❌ Login error:', error);
                    throw error;
                }
                
                console.log('✅ Login successful for:', data.user.email);
                currentUser = data.user;
                
                // Load profile and update UI
                await loadUserProfile();
                showAuthenticatedUI();
                loadDashboardData();
                setupRealtimeSubscriptions();
                
                // Clear the form
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                if (errorDiv) errorDiv.style.display = 'none';
                
            } catch (error) {
                console.error('❌ Login failed:', error);
                if (errorDiv) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                }
            } finally {
                // Reset button state
                setButtonLoading(loginBtn, loginBtnText, false);
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            console.log('👤 Signup attempt started');
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const level = document.getElementById('signupLevel').value;
            const department = document.getElementById('signupDepartment').value;
            const errorDiv = document.getElementById('signupError');
            const signupBtn = document.getElementById('signupBtn');
            const signupBtnText = document.getElementById('signupBtnText');
            
            // Validate required fields
            if (!name || !email || !password || !level || !department) {
                if (errorDiv) {
                    errorDiv.textContent = 'Please fill in all fields';
                    errorDiv.style.display = 'block';
                }
                return;
            }
            
            if (password.length < 6) {
                if (errorDiv) {
                    errorDiv.textContent = 'Password must be at least 6 characters';
                    errorDiv.style.display = 'block';
                }
                return;
            }
            
            try {
                // Show loading state
                setButtonLoading(signupBtn, signupBtnText, true);
                
                console.log('📝 Attempting signup for:', email);
                
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: { 
                        data: { 
                            name: name, 
                            level: level, 
                            department: department 
                        } 
                    }
                });
                
                if (error) {
                    console.error('❌ Signup error:', error);
                    throw error;
                }
                
                console.log('✅ Signup successful for:', data.user.email);
                
                // Create profile in database
                try {
                    const { error: profileError } = await supabase.from('profiles').insert([{
                        id: data.user.id,
                        name: name,
                        email: email,
                        level: level,
                        department: department,
                        created_at: new Date().toISOString()
                    }]);
                    
                    if (profileError) {
                        console.warn('⚠️ Profile creation warning:', profileError);
                        // Don't throw error - user can still login and profile might be created via trigger
                    }
                } catch (profileError) {
                    console.warn('⚠️ Profile creation issue:', profileError);
                    // Continue anyway - profile might be created via database trigger
                }
                
                // Show success message
                alert('Signup successful! Please check your email for verification.');
                
                // Clear the form
                document.getElementById('signupFormElement').reset();
                if (errorDiv) errorDiv.style.display = 'none';
                
                // Switch to login form
                showLoginForm();
                
            } catch (error) {
                console.error('❌ Signup failed:', error);
                if (errorDiv) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                }
            } finally {
                // Reset button state
                setButtonLoading(signupBtn, signupBtnText, false);
            }
        }

        async function handleLogout() {
            try {
                showProgressOverlay('Logging out...');
                await supabase.auth.signOut();
                currentUser = null;
                showUnauthenticatedUI();
                removeAllSubscriptions();
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                hideProgressOverlay();
            }
        }

        function removeAllSubscriptions() {
            console.log('🔕 Removing all real-time subscriptions');
            
            try {
                if (chatSubscription) {
                    supabase.removeChannel(chatSubscription);
                    console.log('✅ Chat subscription removed');
                }
                if (notesSubscription) {
                    supabase.removeChannel(notesSubscription);
                    console.log('✅ Notes subscription removed');
                }
                if (assignmentsSubscription) {
                    supabase.removeChannel(assignmentsSubscription);
                    console.log('✅ Assignments subscription removed');
                }
                if (pastQuestionsSubscription) {
                    supabase.removeChannel(pastQuestionsSubscription);
                    console.log('✅ Past questions subscription removed');
                }
            } catch (error) {
                console.error('❌ Error removing subscriptions:', error);
            }
            
            // Reset subscription variables
            chatSubscription = null;
            notesSubscription = null;
            assignmentsSubscription = null;
            pastQuestionsSubscription = null;
        }

        // User profile management
        async function loadUserProfile() {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        await createUserProfile();
                        return;
                    }
                    throw error;
                }
                
                currentUser.profile = data;
                updateProfileUI();
            } catch (error) {
                console.error('Profile load error:', error);
                await createUserProfile();
            }
        }

        async function createUserProfile() {
            try {
                const userData = currentUser.user_metadata || {};
                const { data, error } = await supabase.from('profiles').insert([{
                    id: currentUser.id,
                    name: userData.name || currentUser.email?.split('@')[0] || 'User',
                    email: currentUser.email,
                    level: userData.level || '100L',
                    department: userData.department || 'General',
                    created_at: new Date()
                }]).select().single();
                
                if (error) throw error;
                currentUser.profile = data;
                updateProfileUI();
            } catch (error) {
                console.error('Profile creation error:', error);
                currentUser.profile = {
                    id: currentUser.id,
                    name: currentUser.user_metadata?.name || currentUser.email?.split('@')[0] || 'User',
                    email: currentUser.email,
                    level: currentUser.user_metadata?.level || '100L',
                    department: currentUser.user_metadata?.department || 'General'
                };
                updateProfileUI();
            }
        }

        function updateProfileUI() {
            if (!currentUser || !currentUser.profile) {
                console.log('❌ No user or profile data available');
                return;
            }
            
            const profile = currentUser.profile;
            
            try {
                // Safely get initials
                const initials = getInitials(profile.name);
                
                // Update navigation elements if they exist
                const userInitials = document.getElementById('userInitials');
                const userName = document.getElementById('userName');
                const welcomeUser = document.getElementById('welcomeUser');
                
                if (userInitials) userInitials.textContent = initials;
                if (userName) userName.textContent = profile.name;
                if (welcomeUser) welcomeUser.textContent = `Hello, ${profile.name}!`;
                
                // Update profile section
                const profileAvatar = document.getElementById('profileAvatar');
                const profileName = document.getElementById('profileName');
                const profileLevel = document.getElementById('profileLevel');
                const profileDepartment = document.getElementById('profileDepartment');
                const profileEmail = document.getElementById('profileEmail');
                const profilePicture = document.getElementById('profilePicture');
                
                if (profileAvatar) profileAvatar.textContent = initials;
                if (profileName) profileName.textContent = profile.name;
                if (profileLevel) profileLevel.textContent = profile.level;
                if (profileDepartment) profileDepartment.textContent = profile.department;
                if (profileEmail) profileEmail.textContent = currentUser.email;
                
                // Set profile picture if available
                if (profilePicture && profile.profile_picture) {
                    profilePicture.src = profile.profile_picture;
                } else if (profilePicture) {
                    profilePicture.src = '';
                    profilePicture.alt = 'Profile Picture';
                    // Use initials as fallback
                    profilePicture.style.backgroundColor = getColorFromName(profile.name);
                    profilePicture.style.display = 'flex';
                    profilePicture.style.alignItems = 'center';
                    profilePicture.style.justifyContent = 'center';
                    profilePicture.style.color = 'white';
                    profilePicture.style.fontWeight = 'bold';
                    profilePicture.style.fontSize = '2rem';
                    profilePicture.textContent = initials;
                }
                
                // Set form values
                const editName = document.getElementById('editName');
                const editLevel = document.getElementById('editLevel');
                const editDepartment = document.getElementById('editDepartment');
                
                if (editName) editName.value = profile.name;
                if (editLevel) editLevel.value = profile.level;
                if (editDepartment) editDepartment.value = profile.department;
                
                // Update unified dropdown (if using new system)
                const dropdownUserName = document.getElementById('dropdownUserName');
                if (dropdownUserName) dropdownUserName.textContent = profile.name;
                
                // Load user contributions and badges
                loadUserContributions();
                loadContributionBadges();
                
            } catch (error) {
                console.error('Error updating profile UI:', error);
            }
        }

        // Load contribution badges
        async function loadContributionBadges() {
            if (!currentUser) return;
            
            try {
                const badgesContainer = document.getElementById('contributionBadges');
                if (!badgesContainer) return;
                
                // Get user contributions
                const { count: notesCount } = await supabase
                    .from('notes')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', currentUser.id);
                
                const { count: assignmentsCount } = await supabase
                    .from('assignments')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', currentUser.id);
                
                const { count: pastQuestionsCount } = await supabase
                    .from('past_questions')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', currentUser.id);
                
                const totalContributions = (notesCount || 0) + (assignmentsCount || 0) + (pastQuestionsCount || 0);
                
                // Determine badge level based on contributions
                let badgeLevel = 1;
                if (totalContributions >= 20) badgeLevel = 5;
                else if (totalContributions >= 15) badgeLevel = 4;
                else if (totalContributions >= 10) badgeLevel = 3;
                else if (totalContributions >= 5) badgeLevel = 2;
                
                const badgeNames = {
                    1: 'Contributor',
                    2: 'Active Contributor',
                    3: 'Pro Contributor',
                    4: 'Expert Contributor',
                    5: 'Master Contributor'
                };
                
                badgesContainer.innerHTML = `
                    <div class="contribution-badge badge-level-${badgeLevel}">
                        <i class="fas fa-trophy"></i>
                        ${badgeNames[badgeLevel]}
                    </div>
                    <div class="contribution-badge" style="background: linear-gradient(135deg, #17a2b8, #20c997);">
                        <i class="fas fa-file-alt"></i>
                        ${totalContributions} Uploads
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading contribution badges:', error);
            }
        }

        // UI State Management
        function showAuthenticatedUI() {
            console.log('🔓 Showing authenticated UI');
            
            // Hide auth section
            const authSection = document.getElementById('auth-section');
            if (authSection) {
                authSection.classList.remove('active');
                authSection.style.display = 'none';
                console.log('✅ Auth section hidden');
            }
            
            // Show all main sections
            document.querySelectorAll('.section').forEach(section => {
                if (section.id !== 'auth-section') {
                    section.style.display = 'block';
                }
            });
            
            // Show bottom navigation with full width
            const bottomNav = document.querySelector('.bottom-nav');
            if (bottomNav) {
                bottomNav.style.display = 'flex';
                bottomNav.style.width = '100%';
                bottomNav.style.visibility = 'visible';
                console.log('✅ Bottom nav shown with full width');
            }
            
            // Update user menu
            updateUserMenu(true);
            
            // Switch to dashboard
            switchSection('dashboard');
        }

        function showUnauthenticatedUI() {
            console.log('🔒 Showing unauthenticated UI');
            
            // Show auth section
            const authSection = document.getElementById('auth-section');
            if (authSection) {
                authSection.classList.add('active');
                authSection.style.display = 'block';
                console.log('✅ Auth section shown');
            }
            
            // Hide all main sections
            document.querySelectorAll('.section').forEach(section => {
                if (section.id !== 'auth-section') {
                    section.style.display = 'none';
                }
            });
            
            // Hide bottom navigation
            const bottomNav = document.querySelector('.bottom-nav');
            if (bottomNav) {
                bottomNav.style.display = 'none';
                console.log('✅ Bottom nav hidden');
            }
            
            // Update user menu
            updateUserMenu(false);
        }

        function updateUserMenu(isAuthenticated) {
            const unauthenticatedMenu = document.getElementById('unauthenticatedMenu');
            const authenticatedMenu = document.getElementById('authenticatedMenu');
            const userIcon = document.getElementById('userIcon');
            
            console.log('🔄 Updating user menu, authenticated:', isAuthenticated);
            
            if (isAuthenticated && currentUser) {
                // Show authenticated menu
                if (unauthenticatedMenu) unauthenticatedMenu.style.display = 'none';
                if (authenticatedMenu) authenticatedMenu.style.display = 'block';
                
                // Update user info
                const dropdownUserName = document.getElementById('dropdownUserName');
                if (dropdownUserName && currentUser.profile) {
                    dropdownUserName.textContent = currentUser.profile.name;
                }
                
                // Change icon to filled user when authenticated
                if (userIcon) {
                    userIcon.className = 'fas fa-user-circle';
                }
            } else {
                // Show unauthenticated menu
                if (unauthenticatedMenu) unauthenticatedMenu.style.display = 'block';
                if (authenticatedMenu) authenticatedMenu.style.display = 'none';
                
                // Change icon to outline user when not authenticated
                if (userIcon) {
                    userIcon.className = 'fas fa-user';
                }
            }
        }

        window.updateUserMenu = updateUserMenu;

        function switchSection(sectionId, fromBackNavigation = false) {
    console.log('🔄 Switching to section:', sectionId, 'fromBack:', fromBackNavigation);
    
    // Don't allow access to main sections without authentication
    if (sectionId !== 'auth-section' && !currentUser) {
        console.log('🚫 Unauthorized access attempt to:', sectionId);
        showUnauthenticatedUI();
        return;
    }
    
    // Update navigation history (unless this is a back navigation)
    if (!fromBackNavigation && !isBackNavigation) {
        const currentSection = document.querySelector('.section.active');
        if (currentSection) {
            navigationHistory.push(currentSection.id);
            console.log('📚 Navigation history:', navigationHistory);
            
            // Update browser history
            window.history.pushState({ section: sectionId }, '', `#${sectionId}`);
        }
    }
    
    isBackNavigation = false;
    
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
        section.style.display = 'none';
    });
    
    // Show target section
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
        targetSection.style.display = 'block';
    }
    
    // Update bottom navigation
    updateBottomNavForSection(sectionId);
    
    // Show/hide back button based on history and screen size
    updateBackButtonVisibility();
    
    // Load section data
    const sectionHandlers = {
        'dashboard': () => { console.log('📊 Loading dashboard'); loadDashboardData(); },
        'notes': () => { console.log('📝 Loading notes'); loadNotes(); },
        'assignments': () => { console.log('📋 Loading assignments'); loadAssignments(); },
        'past-questions': () => { console.log('📚 Loading past questions'); loadPastQuestions(); },
        'chat': () => { console.log('💬 Loading chat'); loadChatUsers(); },
        'profile': () => { console.log('👤 Loading profile'); loadUserContributions(); },
        'user-profile': () => { console.log('👥 Loading user profile'); } // For viewing other users
    };
    
    if (sectionHandlers[sectionId]) {
        sectionHandlers[sectionId]();
    }
}
        // ==================== CHAT FUNCTIONS ====================

        // Load chat users for the sidebar
        async function loadChatUsers() {
            const container = document.getElementById('chatUserList');
            if (!container) return;
            
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('id, name, level, department')
                    .neq('id', currentUser.id)
                    .order('name');
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>No other users online</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = data.map(user => {
                    const initials = getInitials(user.name);
                    return `
                        <div class="chat-item" onclick="selectChatUser('${user.id}', '${user.name}', '${user.level}', '${user.department}', this)">
                            <div class="chat-avatar">${initials}</div>
                            <div class="chat-info">
                                <div class="chat-name">${escapeHtml(user.name)}</div>
                                <div class="chat-preview">${user.level} • ${user.department}</div>
                            </div>
                            <div class="chat-meta">
                                <div class="user-status online"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading users:', error);
                container.innerHTML = '<div class="text-danger p-3">Error loading users</div>';
            }
        }

        // Select user to chat with
        window.selectChatUser = function(userId, userName, userLevel, userDepartment, element) {
            console.log('💬 SELECTING CHAT USER:', userName);
            
            if (!currentUser) {
                alert('Please log in to use chat');
                return;
            }
            
            // Set current chat user
            currentChatUser = { 
                id: userId, 
                name: userName,
                level: userLevel,
                department: userDepartment
            };
            
            console.log('👥 Current chat user set:', currentChatUser);
            
            // Update UI
            const chatHeaderName = document.getElementById('chatHeaderName');
            const chatHeaderStatus = document.getElementById('chatHeaderStatus');
            const chatHeaderAvatar = document.getElementById('chatHeaderAvatar');
            const messageInput = document.getElementById('messageInput');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            
            if (chatHeaderName) {
                chatHeaderName.textContent = userName;
            }
            
            if (chatHeaderStatus) {
                chatHeaderStatus.textContent = `${userLevel} • ${userDepartment}`;
            }
            
            if (chatHeaderAvatar) {
                const initials = getInitials(userName);
                chatHeaderAvatar.innerHTML = initials;
                chatHeaderAvatar.style.backgroundColor = getColorFromName(userName);
            }
            
            if (messageInput) {
                messageInput.disabled = false;
                messageInput.placeholder = `Message ${userName}...`;
            }
            
            if (sendMessageBtn) {
                sendMessageBtn.disabled = false;
            }
            
            // Highlight selected user
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (element) {
                element.classList.add('active');
            }
            
            // Show chat area on mobile - full screen
            const chatMain = document.getElementById('chatMain');
            const chatSidebar = document.querySelector('.chat-sidebar');
            
            if (window.innerWidth <= 768) {
                if (chatMain) chatMain.classList.add('active');
                if (chatSidebar) chatSidebar.style.display = 'none';
            }
            
            // Load chat history
            loadChatHistory(userId);
            
            // Focus input
            setTimeout(() => {
                if (messageInput) messageInput.focus();
            }, 100);
        }

        // Show chat user list (for mobile back button)
        window.showChatUserList = function() {
            const chatMain = document.getElementById('chatMain');
            const chatSidebar = document.querySelector('.chat-sidebar');
            
            if (chatMain) chatMain.classList.remove('active');
            if (chatSidebar) chatSidebar.style.display = 'flex';
        }

        // Load chat history with dates
        window.loadChatHistory = async function(userId) {
            console.log('💬 LOADING CHAT HISTORY FOR:', userId);
            
            const container = document.getElementById('chatMessages');
            if (!container) {
                console.log('❌ Chat container not found for history');
                return;
            }
            
            try {
                // Show loading
                container.innerHTML = `
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading messages...</span>
                        </div>
                        <p class="mt-2">Loading messages...</p>
                    </div>
                `;
                
                // Load messages
                const { data, error } = await supabase
                    .from('messages')
                    .select('*')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${userId}),and(sender_id.eq.${userId},receiver_id.eq.${currentUser.id})`)
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                // Clear container
                container.innerHTML = '';
                displayedMessageIds.clear();
                
                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <p>No messages yet. Start a conversation!</p>
                        </div>
                    `;
                    return;
                }
                
                console.log(`✅ Loaded ${data.length} messages`);
                
                // Group messages by date and display
                let currentDate = null;
                data.forEach(message => {
                    const messageDate = new Date(message.created_at).toDateString();
                    
                    // Add date separator if needed
                    if (currentDate !== messageDate) {
                        currentDate = messageDate;
                        const dateElement = document.createElement('div');
                        dateElement.className = 'message-date';
                        dateElement.textContent = formatMessageDate(message.created_at);
                        container.appendChild(dateElement);
                    }
                    
                    displayMessage(message);
                });
                
                // Scroll to bottom
                scrollChatToBottom();
                
            } catch (error) {
                console.error('❌ Load history error:', error);
                container.innerHTML = `
                    <div class="alert alert-danger m-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading messages
                    </div>
                `;
            }
        }

        // Display message with proper formatting
        window.displayMessage = function(message) {
            console.log('🖥️ DISPLAY MESSAGE CALLED:', message);
            
            // Basic validation
            if (!message || typeof message !== 'object') {
                console.log('❌ Invalid message object');
                return false;
            }
            
            if (!message.content || message.content.trim() === '') {
                console.log('❌ Empty message content');
                return false;
            }
            
            // Skip if already displayed
            if (displayedMessageIds.has(message.id)) {
                console.log('⏭️ Message already displayed, skipping:', message.id);
                return false;
            }
            
            // Get chat container
            const container = document.getElementById('chatMessages');
            if (!container) {
                console.log('❌ Chat container not found');
                return false;
            }
            
            console.log('📦 Container found, proceeding...');
            
            // Remove empty state if it exists
            const emptyStates = container.querySelectorAll('.empty-state, .text-center');
            emptyStates.forEach(state => state.remove());
            
            // Create message element
            const messageElement = document.createElement('div');
            
            // Determine message type
            const isOwnMessage = message.sender_id === currentUser?.id;
            const messageClass = isOwnMessage ? 'own-message' : 'other-message';
            
            // Format time
            let messageTime = 'Now';
            try {
                if (message.created_at) {
                    messageTime = formatTime(message.created_at);
                }
            } catch (e) {
                console.log('⚠️ Time formatting error:', e);
            }
            
            // Create message HTML with line breaks preserved
            messageElement.className = `message ${messageClass}`;
            messageElement.innerHTML = `
                <div class="message-content">
                    <div class="message-text">${formatMessageText(message.content)}</div>
                    <div class="message-time">${messageTime}</div>
                </div>
            `;
            
            // Add to container
            container.appendChild(messageElement);
            displayedMessageIds.add(message.id);
            console.log('✅ Message added to DOM, ID:', message.id);
            
            // Scroll to bottom
            setTimeout(() => {
                scrollChatToBottom();
            }, 100);
            
            return true;
        }

        // Format message text to preserve line breaks
        function formatMessageText(text) {
            return escapeHtml(text).replace(/\n/g, '<br>');
        }

        // Format message date for display
        function formatMessageDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            }
        }

        // Scroll chat to bottom
        window.scrollChatToBottom = function() {
            try {
                const container = document.getElementById('chatMessages');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                    setTimeout(() => {
                        container.scrollTop = container.scrollHeight;
                    }, 50);
                    console.log('✅ Scrolled to bottom');
                }
            } catch (error) {
                console.log('⚠️ Scroll error:', error);
            }
        }

        // Auto-resize textarea
        function autoResizeTextarea() {
            const textarea = document.getElementById('messageInput');
            if (textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
            }
        }

        // Handle chat input keydown events
        function handleChatInputKeydown(e) {
            // Send message on Enter (without Shift)
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
            // Allow line breaks with Shift+Enter
            // The textarea will handle this naturally
        }

        // Send message
        window.sendMessage = async function() {
            console.log('🎯 SEND MESSAGE STARTED');
            
            // Get elements
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendMessageBtn');
            
            // Validate elements
            if (!messageInput) {
                console.log('❌ Message input not found');
                alert('Message input not found');
                return;
            }
            
            if (!sendButton) {
                console.log('❌ Send button not found');
                return;
            }
            
            if (!currentUser) {
                alert('Please log in to send messages');
                return;
            }
            
            if (!currentChatUser) {
                alert('Please select a user to chat with');
                return;
            }
            
            // Get and validate message content
            const content = messageInput.value.trim();
            if (!content) {
                console.log('❌ No message content');
                messageInput.focus();
                return;
            }
            
            console.log('💬 Sending message to:', currentChatUser.name);
            
            // Save original button state
            const originalHTML = sendButton.innerHTML;
            const originalDisabled = sendButton.disabled;
            
            // Set loading state
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            sendButton.disabled = true;
            messageInput.disabled = true;
            
            try {
                // Create message data
                const messageData = {
                    content: content,
                    sender_id: currentUser.id,
                    receiver_id: currentChatUser.id,
                    created_at: new Date().toISOString()
                };
                
                console.log('📤 Sending to database:', messageData);
                
                // Send to database
                const { data, error } = await supabase
                    .from('messages')
                    .insert([messageData])
                    .select();
                
                if (error) {
                    console.error('❌ Database error:', error);
                    throw error;
                }
                
                console.log('✅ Database insert successful:', data);
                
                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';
                console.log('✅ Message process completed');
                
                // Refresh chat to show the new message
                refreshCurrentSection();
                
            } catch (error) {
                console.error('❌ Send message error:', error);
                alert('Failed to send message: ' + error.message);
            } finally {
                // Always reset UI state
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                sendButton.disabled = false;
                messageInput.disabled = false;
                
                // Focus input
                setTimeout(() => {
                    messageInput.focus();
                }, 50);
                
                console.log('🔄 UI reset completed');
            }
        }

        // Enhanced real-time subscription for chat - COMPLETE FIX
function setupRealtimeSubscriptions() {
    if (!currentUser) return;
    
    console.log('🔔 Setting up enhanced real-time subscriptions');
    
    // Remove existing subscriptions
    removeAllSubscriptions();
    
    // Single channel for all real-time updates
    chatSubscription = supabase
        .channel('campusnote-realtime')
        .on(
            'postgres_changes',
            { 
                event: 'INSERT', 
                schema: 'public', 
                table: 'messages',
                filter: `or(receiver_id.eq.${currentUser.id},sender_id.eq.${currentUser.id})`
            },
            (payload) => {
                console.log('💬 REAL-TIME MESSAGE RECEIVED:', payload.new);
                handleNewMessage(payload.new);
            }
        )
        .on(
            'postgres_changes',
            { 
                event: '*', 
                schema: 'public', 
                table: 'notes'
            },
            (payload) => {
                console.log('📝 Notes update:', payload.eventType);
                if (document.getElementById('notes').classList.contains('active')) {
                    setTimeout(() => loadNotes(), 100);
                }
                if (document.getElementById('dashboard').classList.contains('active')) {
                    setTimeout(() => loadRecentNotes(), 100);
                }
            }
        )
        .on(
            'postgres_changes',
            { 
                event: '*', 
                schema: 'public', 
                table: 'assignments'
            },
            (payload) => {
                console.log('📋 Assignments update:', payload.eventType);
                if (document.getElementById('assignments').classList.contains('active')) {
                    setTimeout(() => loadAssignments(), 100);
                }
                if (document.getElementById('dashboard').classList.contains('active')) {
                    setTimeout(() => loadUpcomingAssignments(), 100);
                }
            }
        )
        .on(
            'postgres_changes',
            { 
                event: '*', 
                schema: 'public', 
                table: 'past_questions'
            },
            (payload) => {
                console.log('📚 Past questions update:', payload.eventType);
                if (document.getElementById('past-questions').classList.contains('active')) {
                    setTimeout(() => loadPastQuestions(), 100);
                }
            }
        )
        .subscribe((status) => {
            console.log('🔔 Real-time subscription status:', status);
            if (status === 'SUBSCRIBED') {
                console.log('✅ All real-time subscriptions active');
            }
        });
}

// Handle new messages with proper real-time display
function handleNewMessage(message) {
    console.log('🆕 Processing new message:', message);
    
    // Basic validation
    if (!message || !message.id || !message.content) {
        console.log('❌ Invalid message format');
        return;
    }
    
    // Check if message is already displayed
    if (displayedMessageIds.has(message.id)) {
        console.log('⏭️ Message already displayed, skipping:', message.id);
        return;
    }
    
    // Mark as displayed immediately
    displayedMessageIds.add(message.id);
    
    // Only process if we're in a chat with this user
    const isRelevantMessage = currentChatUser && 
        (message.sender_id === currentChatUser.id || 
         message.receiver_id === currentChatUser.id ||
         message.sender_id === currentUser.id);
    
    if (!isRelevantMessage) {
        console.log('💬 Message not for current chat session');
        
        // Show notification for new messages from other users when not in chat
        if (message.sender_id !== currentUser.id) {
            // Get sender name for notification
            getUserName(message.sender_id).then(senderName => {
                showNotification(`New message from ${senderName}`, 'info');
            });
        }
        return;
    }
    
    console.log('💬 Message is for current chat session');
    
    // Get container
    const container = document.getElementById('chatMessages');
    if (!container) {
        console.log('❌ Chat container not found');
        return;
    }
    
    // Remove empty state if it exists
    const emptyStates = container.querySelectorAll('.empty-state, .text-center');
    emptyStates.forEach(state => state.remove());
    
    // Add date separator if needed
    addDateSeparator(container, message.created_at);
    
    // Display the message immediately
    const displaySuccess = displayMessage(message);
    
    if (displaySuccess) {
        console.log('✅ Message displayed successfully');
        
        // Scroll to bottom
        scrollChatToBottom();
        
        // Show notification for new messages from other users
        if (message.sender_id !== currentUser.id) {
            showNotification(`New message from ${currentChatUser.name}`);
        }
    } else {
        console.log('❌ Failed to display message');
    }
}

// Add date separator if needed
function addDateSeparator(container, messageDate) {
    if (!container || !messageDate) return;
    
    const messages = container.querySelectorAll('.message');
    let needsDateSeparator = true;
    
    if (messages.length > 0) {
        const lastMessage = messages[messages.length - 1];
        const lastMessageTime = lastMessage.querySelector('.message-time');
        if (lastMessageTime) {
            const lastDate = new Date().toDateString(); // Approximate
            const messageDateStr = new Date(messageDate).toDateString();
            if (lastDate === messageDateStr) {
                needsDateSeparator = false;
            }
        }
    }
    
    if (needsDateSeparator) {
        const dateElement = document.createElement('div');
        dateElement.className = 'message-date';
        dateElement.textContent = formatMessageDate(messageDate);
        container.appendChild(dateElement);
    }
}

// Get user name for notifications
async function getUserName(userId) {
    try {
        const { data, error } = await supabase
            .from('profiles')
            .select('name')
            .eq('id', userId)
            .single();
            
        if (error) throw error;
        return data.name || 'User';
    } catch (error) {
        console.error('Error getting user name:', error);
        return 'User';
    }
}

// Enhanced displayMessage function
window.displayMessage = function(message) {
    console.log('🖥️ DISPLAY MESSAGE:', message);
    
    // Enhanced validation
    if (!message || typeof message !== 'object') {
        console.log('❌ Invalid message object');
        return false;
    }
    
    if (!message.id) {
        console.log('❌ Message missing ID');
        return false;
    }
    
    if (!message.content || message.content.trim() === '') {
        console.log('❌ Empty message content');
        return false;
    }
    
    // Skip if already displayed
    if (displayedMessageIds.has(message.id)) {
        console.log('⏭️ Message already displayed, skipping:', message.id);
        return false;
    }
    
    // Get chat container
    const container = document.getElementById('chatMessages');
    if (!container) {
        console.log('❌ Chat container not found');
        return false;
    }
    
    console.log('📦 Container found, creating message element...');
    
    // Remove empty state if it exists
    const emptyStates = container.querySelectorAll('.empty-state, .text-center');
    emptyStates.forEach(state => state.remove());
    
    // Create message element
    const messageElement = document.createElement('div');
    
    // Determine message type
    const isOwnMessage = message.sender_id === currentUser?.id;
    const messageClass = isOwnMessage ? 'own-message' : 'other-message';
    
    // Format time
    let messageTime = 'Now';
    try {
        if (message.created_at) {
            messageTime = formatTime(message.created_at);
        }
    } catch (e) {
        console.log('⚠️ Time formatting error:', e);
    }
    
    // Create message HTML with proper formatting
    messageElement.className = `message ${messageClass}`;
    messageElement.dataset.messageId = message.id;
    messageElement.innerHTML = `
        <div class="message-content">
            <div class="message-text">${formatMessageText(message.content)}</div>
            <div class="message-time">${messageTime}</div>
        </div>
    `;
    
    // Add to container
    container.appendChild(messageElement);
    displayedMessageIds.add(message.id);
    
    console.log('✅ Message added to DOM, ID:', message.id);
    
    return true;
}

// Enhanced sendMessage function with immediate display
window.sendMessage = async function() {
    console.log('🎯 SEND MESSAGE STARTED');
    
    // Get elements
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendMessageBtn');
    
    // Validate elements
    if (!messageInput) {
        console.log('❌ Message input not found');
        alert('Message input not found');
        return;
    }
    
    if (!sendButton) {
        console.log('❌ Send button not found');
        return;
    }
    
    if (!currentUser) {
        alert('Please log in to send messages');
        return;
    }
    
    if (!currentChatUser) {
        alert('Please select a user to chat with');
        return;
    }
    
    // Get and validate message content
    const content = messageInput.value.trim();
    if (!content) {
        console.log('❌ No message content');
        messageInput.focus();
        return;
    }
    
    console.log('💬 Sending message to:', currentChatUser.name);
    
    // Save original button state
    const originalHTML = sendButton.innerHTML;
    const originalDisabled = sendButton.disabled;
    
    // Set loading state
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    sendButton.disabled = true;
    messageInput.disabled = true;
    
    try {
        // Create message data
        const messageData = {
            content: content,
            sender_id: currentUser.id,
            receiver_id: currentChatUser.id,
            created_at: new Date().toISOString()
        };
        
        console.log('📤 Sending to database:', messageData);
        
        // OPTIMISTIC UPDATE: Create temporary message for immediate display
        const tempMessage = {
            id: 'temp-' + Date.now(),
            content: content,
            sender_id: currentUser.id,
            receiver_id: currentChatUser.id,
            created_at: new Date().toISOString()
        };
        
        // Display temporary message immediately
        displayMessage(tempMessage);
        scrollChatToBottom();
        
        // Clear input immediately for better UX
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        // Send to database
        const { data, error } = await supabase
            .from('messages')
            .insert([messageData])
            .select();
        
        if (error) {
            console.error('❌ Database error:', error);
            
            // Remove temporary message on error
            const tempElement = document.querySelector(`[data-message-id="${tempMessage.id}"]`);
            if (tempElement) {
                tempElement.remove();
                displayedMessageIds.delete(tempMessage.id);
            }
            
            throw error;
        }
        
        console.log('✅ Database insert successful:', data);
        
        // The real-time subscription will handle displaying the actual message
        // and removing the temporary one
        
    } catch (error) {
        console.error('❌ Send message error:', error);
        alert('Failed to send message: ' + error.message);
    } finally {
        // Always reset UI state
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
        sendButton.disabled = false;
        messageInput.disabled = false;
        
        // Focus input
        setTimeout(() => {
            if (messageInput) messageInput.focus();
        }, 50);
        
        console.log('🔄 UI reset completed');
    }
};

// Enhanced scroll function
window.scrollChatToBottom = function() {
    try {
        const container = document.getElementById('chatMessages');
        if (container) {
            // Use multiple attempts to ensure scroll
            container.scrollTop = container.scrollHeight;
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 50);
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 200);
            console.log('✅ Scrolled to bottom');
        }
    } catch (error) {
        console.log('⚠️ Scroll error:', error);
    }
};

// ==================== BOTTOM NAVIGATION ====================

        function updateBottomNav(activeItem) {
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            activeItem.classList.add('active');
        }

        function updateBottomNavForSection(sectionId) {
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-section') === sectionId) {
                    item.classList.add('active');
                }
            });
        }
        
        // ==================== REFRESH FUNCTIONS ====================

        // Refresh current section
        function refreshCurrentSection() {
            const activeSection = document.querySelector('.section.active');
            if (!activeSection) return;
            
            const sectionId = activeSection.id;
            console.log('🔄 Refreshing section:', sectionId);
            
            const refreshHandlers = {
                'dashboard': loadDashboardData,
                'notes': loadNotes,
                'assignments': loadAssignments,
                'past-questions': loadPastQuestions,
                'chat': loadChatUsers,
                'profile': () => {
                    loadUserProfile();
                    loadUserContributions();
                    loadContributionBadges();
                }
            };
            
            if (refreshHandlers[sectionId]) {
                refreshHandlers[sectionId]();
            }
        }

        // ==================== LOADING INDICATORS ====================

        // Show progress overlay
        function showProgressOverlay(text = 'Processing...') {
            const overlay = document.getElementById('progressOverlay');
            const progressText = document.getElementById('progressText');
            
            if (overlay) overlay.style.display = 'flex';
            if (progressText) progressText.textContent = text;
        }

        // Hide progress overlay
        function hideProgressOverlay() {
            const overlay = document.getElementById('progressOverlay');
            if (overlay) overlay.style.display = 'none';
        }

        // Set button loading state
        function setButtonLoading(button, buttonText, isLoading) {
            if (!button || !buttonText) return;
            
            if (isLoading) {
                button.disabled = true;
                button.classList.add('button-loading');
                buttonText.textContent = 'Processing...';
            } else {
                button.disabled = false;
                button.classList.remove('button-loading');
                
                // Reset to original text based on button ID
                const buttonId = button.id;
                const originalTexts = {
                    'loginBtn': 'Login',
                    'signupBtn': 'Sign Up',
                    'saveNoteBtn': 'Save Note',
                    'saveAssignmentBtn': 'Save Assignment',
                    'savePastQuestionBtn': 'Save Past Question',
                    'updateProfileBtn': 'Update Profile'
                };
                
                if (originalTexts[buttonId]) {
                    buttonText.textContent = originalTexts[buttonId];
                }
            }
        }

        // ==================== PROFILE PICTURE UPLOAD ====================

        // Upload profile picture
        async function uploadProfilePicture(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            
            // Validate file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size should be less than 5MB');
                return;
            }
            
            try {
                showProgressOverlay('Uploading profile picture...');
                
                // Upload to Supabase storage - use existing buckets
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}/profile-picture.${fileExt}`;
                
                // Try to upload to the 'notes' bucket (which exists)
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('notes')
                    .upload(fileName, file, { upsert: true });
                
                if (uploadError) {
                    // If notes bucket fails, try assignments bucket
                    const { data: uploadData2, error: uploadError2 } = await supabase.storage
                        .from('assignments')
                        .upload(fileName, file, { upsert: true });
                    
                    if (uploadError2) throw uploadError2;
                }
                
                // Get public URL from the successful upload
                const { data: { publicUrl } } = supabase.storage
                    .from('notes')
                    .getPublicUrl(fileName);
                
                // Update profile in database
                const { error: updateError } = await supabase
                    .from('profiles')
                    .update({ profile_picture: publicUrl })
                    .eq('id', currentUser.id);
                
                if (updateError) throw updateError;
                
                // Update UI
                const profilePicture = document.getElementById('profilePicture');
                if (profilePicture) {
                    profilePicture.src = publicUrl;
                    profilePicture.style.backgroundColor = '';
                    profilePicture.style.display = 'block';
                    profilePicture.textContent = '';
                }
                
                // Update current user profile
                if (currentUser.profile) {
                    currentUser.profile.profile_picture = publicUrl;
                }
                
                showNotification('Profile picture updated successfully!');
                
            } catch (error) {
                console.error('Error uploading profile picture:', error);
                alert('Failed to upload profile picture: ' + error.message);
            } finally {
                hideProgressOverlay();
            }
        }

        // ==================== DATA LOADING FUNCTIONS ====================

        async function loadDashboardData() {
            await loadRecentNotes();
            await loadUpcomingAssignments();
        }

        async function loadRecentNotes() {
            const container = document.getElementById('recentNotesContent');
            if (!container) return;
            
            try {
                const { data, error } = await supabase
                    .from('notes')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-sticky-note"></i>
                            <p>No notes yet</p>
                            <small class="text-muted">Add your first note to get started</small>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = data.map(note => `
                    <div class="list-item">
                        <div class="list-item-title">${escapeHtml(note.title)}</div>
                        <div class="list-item-meta">${escapeHtml(note.course)} • ${formatDate(note.created_at)}</div>
                    </div>
                `).join('');
                
            } catch (error) {
                container.innerHTML = '<p class="text-danger">Error loading notes</p>';
            }
        }

        async function loadUpcomingAssignments() {
            const container = document.getElementById('upcomingAssignmentsContent');
            if (!container) return;
            
            try {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                
                const { data, error } = await supabase
                    .from('assignments')
                    .select('*')
                    .gte('due_date', tomorrowStr)
                    .order('due_date', { ascending: true })
                    .limit(5);
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-tasks"></i>
                            <p>No upcoming assignments</p>
                            <small class="text-muted">All caught up!</small>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = data.map(assignment => `
                    <div class="list-item">
                        <div class="list-item-title">${escapeHtml(assignment.title)}</div>
                        <div class="list-item-meta">${escapeHtml(assignment.course)} • Due: ${formatDate(assignment.due_date)}</div>
                    </div>
                `).join('');
                
            } catch (error) {
                container.innerHTML = '<p class="text-danger">Error loading assignments</p>';
            }
        }

        async function loadNotes() {
            const container = document.getElementById('notesContent');
            if (!container) return;
            
            try {
                const { data, error } = await supabase
                    .from('notes')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // Store all notes for search functionality
                allNotes = data || [];
                
                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-sticky-note"></i>
                            <h5>No Notes Yet</h5>
                            <p>Start by sharing your first lecture note with classmates</p>
                            <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                                <i class="fas fa-plus me-2"></i>Add Your First Note
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = data.map(note => `
    <div class="list-item" data-item-id="${note.id}">
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                <div class="list-item-title">${escapeHtml(note.title)}</div>
                <div class="list-item-meta">
                    By <span class="user-link" onclick="viewUserProfile('${note.user_id}', '${escapeHtml(getUserNameFromNote(note))}')">${escapeHtml(getUserNameFromNote(note))}</span> • 
                    ${escapeHtml(note.course)} • ${formatDate(note.created_at)}
                </div>
                
                ${note.description ? `
                    <div class="note-description mt-2 p-3 bg-light rounded">
                        <p class="mb-0">${escapeHtml(note.description)}</p>
                    </div>
                ` : ''}
                
                ${note.file_url ? `
                    <div class="file-attachment mt-2">
                        <i class="fas fa-paperclip me-1"></i>
                        <span class="file-name">${note.file_name || 'Attached file'}</span>
                        <div class="file-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="previewFile('${note.file_url}', '${note.file_type}', '${note.file_name || 'File'}', 'notes')">
                                <i class="fas fa-eye me-1"></i>Preview
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="downloadFile('${note.file_url}', '${note.file_name || 'download'}')">
                                <i class="fas fa-download me-1"></i>Download
                            </button>
                        </div>
                    </div>
                ` : ''}
            </div>
            <div class="d-flex flex-column">
                ${note.user_id === currentUser?.id ? `
                    <button class="btn btn-sm btn-outline-danger mb-1" onclick="deleteNote('${note.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : `
                    <button class="btn btn-sm btn-outline-primary mb-1" onclick="viewUserProfile('${note.user_id}', '${escapeHtml(getUserNameFromNote(note))}')">
                        <i class="fas fa-user"></i>
                    </button>
                `}
            </div>
        </div>
    </div>
`).join('');
                
            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>Error loading notes</h5>
                        <p class="mb-0">${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadAssignments() {
    const container = document.getElementById('assignmentsContent');
    if (!container) return;
    
    try {
        const { data, error } = await supabase
            .from('assignments')
            .select('*')
            .order('due_date', { ascending: true });
        
        if (error) throw error;
        
        // Store all assignments for search functionality
        allAssignments = data || [];
        
        if (!data || data.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <h5>No Assignments Yet</h5>
                    <p>Track your assignments and deadlines here</p>
                    <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addAssignmentModal">
                        <i class="fas fa-plus me-2"></i>Add Your First Assignment
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = data.map(assignment => `
            <div class="list-item" data-item-id="${assignment.id}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="list-item-title">${escapeHtml(assignment.title)}</div>
                        <div class="list-item-meta">
                            By <span class="user-link" onclick="viewUserProfile('${assignment.user_id}', '${escapeHtml(getUserNameFromItem(assignment))}')">${escapeHtml(getUserNameFromItem(assignment))}</span> • 
                            ${escapeHtml(assignment.course)} • Due: ${formatDate(assignment.due_date)}
                        </div>
                        
                        ${assignment.description ? `
                            <div class="note-description mt-2 p-3 bg-light rounded">
                                <p class="mb-0">${escapeHtml(assignment.description)}</p>
                            </div>
                        ` : ''}
                        
                        ${assignment.file_url ? `
                            <div class="file-attachment mt-2">
                                <i class="fas fa-paperclip me-1"></i>
                                <span class="file-name">${assignment.file_name || 'Attached file'}</span>
                                <div class="file-actions">
                                    <button class="btn btn-sm btn-outline-primary" onclick="previewFile('${assignment.file_url}', '${assignment.file_type}', '${assignment.file_name || 'File'}', 'assignments')">
                                        <i class="fas fa-eye me-1"></i>Preview
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="downloadFile('${assignment.file_url}', '${assignment.file_name || 'download'}')">
                                        <i class="fas fa-download me-1"></i>Download
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="d-flex flex-column">
                        ${assignment.user_id === currentUser?.id ? `
                            <button class="btn btn-sm btn-outline-danger mb-1" onclick="deleteAssignment('${assignment.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : `
                            <button class="btn btn-sm btn-outline-primary mb-1" onclick="viewUserProfile('${assignment.user_id}', '${escapeHtml(getUserNameFromItem(assignment))}')">
                                <i class="fas fa-user"></i>
                            </button>
                        `}
                    </div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        container.innerHTML = `
            <div class="alert alert-danger">
                <h5>Error loading assignments</h5>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    }
}
        async function loadPastQuestions() {
    const container = document.getElementById('pastQuestionsContent');
    if (!container) return;
    
    try {
        const { data, error } = await supabase
            .from('past_questions')
            .select('*')
            .order('year', { ascending: false });
        
        if (error) throw error;
        
        // Store all past questions for search functionality
        allPastQuestions = data || [];
        
        if (!data || data.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-file-alt"></i>
                    <h5>No Past Questions Yet</h5>
                    <p>Share past exam questions to help your classmates</p>
                    <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addPastQuestionModal">
                        <i class="fas fa-plus me-2"></i>Add Your First Past Question
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = data.map(pq => `
            <div class="list-item" data-item-id="${pq.id}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="list-item-title">${escapeHtml(pq.title)}</div>
                        <div class="list-item-meta">
                            By <span class="user-link" onclick="viewUserProfile('${pq.user_id}', '${escapeHtml(getUserNameFromItem(pq))}')">${escapeHtml(getUserNameFromItem(pq))}</span> • 
                            ${escapeHtml(pq.course)} • ${pq.year}
                        </div>
                        
                        ${pq.description ? `
                            <div class="note-description mt-2 p-3 bg-light rounded">
                                <p class="mb-0">${escapeHtml(pq.description)}</p>
                            </div>
                        ` : ''}
                        
                        ${pq.file_url ? `
                            <div class="file-attachment mt-2">
                                <i class="fas fa-paperclip me-1"></i>
                                <span class="file-name">${pq.file_name || 'Attached file'}</span>
                                <div class="file-actions">
                                    <button class="btn btn-sm btn-outline-primary" onclick="previewFile('${pq.file_url}', '${pq.file_type}', '${pq.file_name || 'File'}', 'past-questions')">
                                        <i class="fas fa-eye me-1"></i>Preview
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="downloadFile('${pq.file_url}', '${pq.file_name || 'download'}')">
                                        <i class="fas fa-download me-1"></i>Download
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="d-flex flex-column">
                        ${pq.user_id === currentUser?.id ? `
                            <button class="btn btn-sm btn-outline-danger mb-1" onclick="deletePastQuestion('${pq.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : `
                            <button class="btn btn-sm btn-outline-primary mb-1" onclick="viewUserProfile('${pq.user_id}', '${escapeHtml(getUserNameFromItem(pq))}')">
                                <i class="fas fa-user"></i>
                            </button>
                        `}
                    </div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        container.innerHTML = `
            <div class="alert alert-danger">
                <h5>Error loading past questions</h5>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    }
}
        // Save new note with file upload
        async function saveNote() {
            const title = document.getElementById('noteTitle');
            const course = document.getElementById('noteCourse');
            const description = document.getElementById('noteDescription');
            const noteFilesInput = document.getElementById('noteFiles');
            const saveNoteBtn = document.getElementById('saveNoteBtn');
            const saveNoteBtnText = document.getElementById('saveNoteBtnText');
            
            if (!title || !course || !noteFilesInput) return;
            
            // Validate required fields
            if (!title.value.trim()) {
                alert('Please enter a note title');
                title.focus();
                return;
            }
            
            if (!course.value.trim()) {
                alert('Please enter a course');
                course.focus();
                return;
            }
            
            if (!noteFilesInput.files.length) {
                alert('Please select a file to upload');
                return;
            }
            
            try {
                // Show loading state
                setButtonLoading(saveNoteBtn, saveNoteBtnText, true);
                
                // Upload file
                const file = noteFilesInput.files[0];
                const fileData = await uploadFileToStorage(file, 'notes', currentUser.id);
                
                const noteData = {
        title: title.value.trim(),
        course: course.value.trim(),
        description: description.value.trim(), // ADD THIS
        user_id: currentUser.id,
        created_at: new Date().toISOString(),
        file_url: fileData.url,
        file_name: fileData.name,
        file_type: fileData.type
    };
                
                const { error } = await supabase.from('notes').insert([noteData]);
                
                if (error) throw error;
                
                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('addNoteModal'));
                if (modal) modal.hide();
                
                document.getElementById('addNoteForm').reset();
                document.getElementById('noteFilesPreview').innerHTML = '';
                
                showNotification('Note saved successfully!');
                
                // Refresh notes section
                refreshCurrentSection();
                
            } catch (error) {
                console.error('Error saving note:', error);
                alert('Error saving note: ' + error.message);
            } finally {
                // Reset button state
                setButtonLoading(saveNoteBtn, saveNoteBtnText, false);
            }
        }

        // Save new assignment with file upload
        async function saveAssignment() {
            const title = document.getElementById('assignmentTitle');
            const course = document.getElementById('assignmentCourse');
            const description = document.getElementById('assignmentDescription');
            const dueDate = document.getElementById('assignmentDueDate');
            const assignmentFilesInput = document.getElementById('assignmentFiles');
            const saveAssignmentBtn = document.getElementById('saveAssignmentBtn');
            const saveAssignmentBtnText = document.getElementById('saveAssignmentBtnText');
            
            if (!title || !course || !assignmentFilesInput) return;
            
            // Validate required fields
            if (!title.value.trim()) {
                alert('Please enter an assignment title');
                title.focus();
                return;
            }
            
            if (!course.value.trim()) {
                alert('Please enter a course');
                course.focus();
                return;
            }
            
            if (!assignmentFilesInput.files.length) {
                alert('Please select a file to upload');
                return;
            }
            
            try {
                // Show loading state
                setButtonLoading(saveAssignmentBtn, saveAssignmentBtnText, true);
                
                // Upload file
                const file = assignmentFilesInput.files[0];
                const fileData = await uploadFileToStorage(file, 'assignments', currentUser.id);
                
                const assignmentData = {
                    title: title.value.trim(),
                    course: course.value.trim(),
                    description: description.value.trim(),
                    due_date: dueDate.value || null,
                    user_id: currentUser.id,
                    created_at: new Date().toISOString(),
                    file_url: fileData.url,
                    file_name: fileData.name,
                    file_type: fileData.type
                };
                
                const { error } = await supabase.from('assignments').insert([assignmentData]);
                
                if (error) throw error;
                
                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('addAssignmentModal'));
                if (modal) modal.hide();
                
                document.getElementById('addAssignmentForm').reset();
                document.getElementById('assignmentFilesPreview').innerHTML = '';
                
                showNotification('Assignment saved successfully!');
                
                // Refresh assignments section
                refreshCurrentSection();
                
            } catch (error) {
                console.error('Error saving assignment:', error);
                alert('Error saving assignment: ' + error.message);
            } finally {
                // Reset button state
                setButtonLoading(saveAssignmentBtn, saveAssignmentBtnText, false);
            }
        }

        // Save new past question with file upload
        async function savePastQuestion() {
            const title = document.getElementById('pastQuestionTitle');
            const course = document.getElementById('pastQuestionCourse');
            const description = document.getElementById('pastQuestionDescription');
            const year = document.getElementById('pastQuestionYear');
            const pastQuestionFileInput = document.getElementById('pastQuestionFile');
            const savePastQuestionBtn = document.getElementById('savePastQuestionBtn');
            const savePastQuestionBtnText = document.getElementById('savePastQuestionBtnText');
            
            if (!title || !course || !year || !pastQuestionFileInput) return;
            
            // Validate required fields
            if (!title.value.trim()) {
                alert('Please enter a title');
                title.focus();
                return;
            }
            
            if (!course.value.trim()) {
                alert('Please enter a course');
                course.focus();
                return;
            }
            
            if (!year.value) {
                alert('Please enter a year');
                year.focus();
                return;
            }
            
            if (!pastQuestionFileInput.files.length) {
                alert('Please select a file to upload');
                return;
            }
            
            try {
                // Show loading state
                setButtonLoading(savePastQuestionBtn, savePastQuestionBtnText, true);
                
                // Upload file
                const file = pastQuestionFileInput.files[0];
                const fileData = await uploadFileToStorage(file, 'past-questions', currentUser.id);
                
                const pastQuestionData = {
                    title: title.value.trim(),
                    course: course.value.trim(),
                    description: description.value.trim(),
                    year: year.value,
                    user_id: currentUser.id,
                    created_at: new Date().toISOString(),
                    file_url: fileData.url,
                    file_name: fileData.name,
                    file_type: fileData.type
                };
                
                const { error } = await supabase.from('past_questions').insert([pastQuestionData]);
                
                if (error) throw error;
                
                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('addPastQuestionModal'));
                if (modal) modal.hide();
                
                document.getElementById('addPastQuestionForm').reset();
                document.getElementById('pastQuestionFilePreview').innerHTML = '';
                
                showNotification('Past question saved successfully!');
                
                // Refresh past questions section
                refreshCurrentSection();
                
            } catch (error) {
                console.error('Error saving past question:', error);
                alert('Error saving past question: ' + error.message);
            } finally {
                // Reset button state
                setButtonLoading(savePastQuestionBtn, savePastQuestionBtnText, false);
            }
        }

        // Profile Management
        async function updateProfile(e) {
            e.preventDefault();
            
            const name = document.getElementById('editName');
            const level = document.getElementById('editLevel');
            const department = document.getElementById('editDepartment');
            const updateProfileBtn = document.getElementById('updateProfileBtn');
            const updateProfileBtnText = document.getElementById('updateProfileBtnText');
            
            if (!name || !level || !department) return;
            
            try {
                // Show loading state
                setButtonLoading(updateProfileBtn, updateProfileBtnText, true);
                
                const { error } = await supabase
                    .from('profiles')
                    .update({
                        name: name.value,
                        level: level.value,
                        department: department.value
                    })
                    .eq('id', currentUser.id);
                
                if (error) throw error;
                
                await loadUserProfile();
                showNotification('Profile updated successfully!');
                
            } catch (error) {
                alert('Error updating profile: ' + error.message);
            } finally {
                // Reset button state
                setButtonLoading(updateProfileBtn, updateProfileBtnText, false);
            }
        }

        async function loadUserContributions() {
            if (!currentUser) return;
            
            try {
                const { count: notesCount } = await supabase
                    .from('notes')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', currentUser.id);
                
                const { count: assignmentsCount } = await supabase
                    .from('assignments')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', currentUser.id);
                
                const { count: pastQuestionsCount } = await supabase
                    .from('past_questions')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', currentUser.id);
                
                const myNotesCount = document.getElementById('myNotesCount');
                const myAssignmentsCount = document.getElementById('myAssignmentsCount');
                const myPastQuestionsCount = document.getElementById('myPastQuestionsCount');
                
                if (myNotesCount) myNotesCount.textContent = notesCount || 0;
                if (myAssignmentsCount) myAssignmentsCount.textContent = assignmentsCount || 0;
                if (myPastQuestionsCount) myPastQuestionsCount.textContent = pastQuestionsCount || 0;
            } catch (error) {
                console.error('Error loading user contributions:', error);
            }
        }

        // Delete Functions
        window.deleteNote = async function(noteId) {
            if (!confirm('Are you sure you want to delete this note?')) return;
            try {
                showProgressOverlay('Deleting note...');
                const { error } = await supabase
                    .from('notes')
                    .delete()
                    .eq('id', noteId)
                    .eq('user_id', currentUser.id);
                if (error) throw error;
                // Real-time will handle the refresh
                refreshCurrentSection();
            } catch (error) {
                alert('Error deleting note: ' + error.message);
            } finally {
                hideProgressOverlay();
            }
        };

        window.deleteAssignment = async function(assignmentId) {
            if (!confirm('Are you sure you want to delete this assignment?')) return;
            try {
                showProgressOverlay('Deleting assignment...');
                const { error } = await supabase
                    .from('assignments')
                    .delete()
                    .eq('id', assignmentId)
                    .eq('user_id', currentUser.id);
                if (error) throw error;
                // Real-time will handle the refresh
                refreshCurrentSection();
            } catch (error) {
                alert('Error deleting assignment: ' + error.message);
            } finally {
                hideProgressOverlay();
            }
        };

        window.deletePastQuestion = async function(pastQuestionId) {
            if (!confirm('Are you sure you want to delete this past question?')) return;
            try {
                showProgressOverlay('Deleting past question...');
                const { error } = await supabase
                    .from('past_questions')
                    .delete()
                    .eq('id', pastQuestionId)
                    .eq('user_id', currentUser.id);
                if (error) throw error;
                // Real-time will handle the refresh
                refreshCurrentSection();
            } catch (error) {
                alert('Error deleting past question: ' + error.message);
            } finally {
                hideProgressOverlay();
            }
        };

        // ==================== UTILITY FUNCTIONS ====================

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        function formatTime(dateString) {
            const options = { hour: '2-digit', minute: '2-digit' };
            return new Date(dateString).toLocaleTimeString(undefined, options);
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        function getUserNameFromNote(note) {
    // This would ideally come from a joined query, but for now:
    return currentUser?.profile?.name || 'User';
}

        // Upload file to Supabase storage
        async function uploadFileToStorage(file, bucketName, folder = '') {
            try {
                const fileExt = file.name.split('.').pop();
                
                // REMOVE the "public/" prefix from the file path
                // Supabase automatically makes files public when you use getPublicUrl()
                const fileName = `${folder}/${Math.random().toString(36).substring(2)}_${Date.now()}.${fileExt}`;
                
                console.log('📤 UPLOAD DETAILS:');
                console.log('  Bucket:', bucketName);
                console.log('  File name:', file.name);
                console.log('  Storage path:', fileName);
                
                const { data, error } = await supabase.storage
                    .from(bucketName)
                    .upload(fileName, file);

                if (error) {
                    console.error('❌ Upload failed:', error);
                    throw error;
                }

                // Get public URL - this is correct
                const { data: { publicUrl } } = supabase.storage
                    .from(bucketName)
                    .getPublicUrl(fileName);

                console.log('✅ UPLOAD SUCCESS:');
                console.log('  Public URL:', publicUrl);
                console.log('  File name:', file.name);
                console.log('  File type:', file.type);
                
                return {
                    url: publicUrl,
                    name: file.name,
                    type: file.type
                };

            } catch (error) {
                console.error('❌ Upload error:', error);
                throw error;
            }
        }

        // Get user initials
        function getInitials(name) {
            if (!name || typeof name !== 'string') return 'U';
            try {
                return name.split(' ')
                    .map(word => word.charAt(0))
                    .join('')
                    .toUpperCase()
                    .substring(0, 2);
            } catch (error) {
                console.error('Error getting initials:', error);
                return 'U';
            }
        }

        // Get color from name for avatar background
        function getColorFromName(name) {
            if (!name) return '#4361ee';
            
            const colors = [
                '#4361ee', '#3a0ca3', '#4cc9f0', '#f72585', 
                '#7209b7', '#3f37c9', '#4895ef', '#560bad',
                '#480ca8', '#4a4e69', '#22223b', '#9a8c98'
            ];
            
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            return colors[Math.abs(hash) % colors.length];
        }

        // File upload handlers
        function setupFileUploadHandlers() {
            // Note files upload
            const noteFilesInput = document.getElementById('noteFiles');
            if (noteFilesInput) {
                noteFilesInput.addEventListener('change', function(e) {
                    handleFileUpload(e, 'noteFilesPreview', 'notes');
                });
            }

            // Assignment files upload
            const assignmentFilesInput = document.getElementById('assignmentFiles');
            if (assignmentFilesInput) {
                assignmentFilesInput.addEventListener('change', function(e) {
                    handleFileUpload(e, 'assignmentFilesPreview', 'assignments');
                });
            }

            // Past question file upload
            const pastQuestionFileInput = document.getElementById('pastQuestionFile');
            if (pastQuestionFileInput) {
                pastQuestionFileInput.addEventListener('change', function(e) {
                    handleFileUpload(e, 'pastQuestionFilePreview', 'past-questions', true);
                });
            }
        }

        // Handle file upload with preview
        function handleFileUpload(event, previewContainerId, fileType, singleFile = false) {
            const files = event.target.files;
            const previewContainer = document.getElementById(previewContainerId);
            
            if (!previewContainer) return;

            if (singleFile && files.length > 1) {
                alert('Please select only one file.');
                event.target.value = '';
                return;
            }

            previewContainer.innerHTML = '';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Check file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    continue;
                }

                const fileItem = document.createElement('div');
                fileItem.className = 'file-preview-item';
                fileItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="file-info">
                            <i class="fas ${getFileIcon(file.type)} me-2"></i>
                            <span class="file-name">${file.name}</span>
                            <small class="text-muted ms-2">(${formatFileSize(file.size)})</small>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="previewFile(this, '${fileType}')" data-file="${file.name}" data-type="${file.type}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeFile(this, '${event.target.id}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                fileItem.dataset.file = file;
                previewContainer.appendChild(fileItem);
            }
        }

        // Get file icon based on file type
        function getFileIcon(fileType) {
            if (fileType.includes('pdf')) return 'fa-file-pdf';
            if (fileType.includes('word') || fileType.includes('document')) return 'fa-file-word';
            if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'fa-file-excel';
            if (fileType.includes('image')) return 'fa-file-image';
            if (fileType.includes('zip') || fileType.includes('rar')) return 'fa-file-archive';
            return 'fa-file';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Remove file from preview
        function removeFile(element, inputId) {
            const fileItem = element.closest('.file-preview-item');
            fileItem.remove();
            
            // Clear the file input
            const fileInput = document.getElementById(inputId);
            if (fileInput) {
                fileInput.value = '';
            }
        }

        // Show notification
        function showNotification(message) {
            // Create a simple notification
            const notification = document.createElement('div');
            notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 100px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // ==================== FILE PREVIEW FUNCTIONS ====================

        // Preview file in modal
        window.previewFile = function(fileUrl, fileType, fileName, section) {
            currentPreviewFile = {
                url: fileUrl,
                name: fileName,
                type: fileType
            };
            
            const modal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
            const title = document.getElementById('filePreviewTitle');
            const content = document.getElementById('filePreviewContent');
            
            if (title) title.textContent = `Preview: ${fileName}`;
            
            // Show loading
            content.innerHTML = `
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading preview...</span>
                </div>
                <p class="mt-2">Loading preview...</p>
            `;
            
            modal.show();
            
            // Load preview based on file type
            setTimeout(() => {
                loadFilePreview(fileUrl, fileType, fileName, content);
            }, 500);
        };

        // Load file preview based on file type
        function loadFilePreview(fileUrl, fileType, fileName, contentContainer) {
            if (fileType.includes('image')) {
                // Image preview
                contentContainer.innerHTML = `
                    <img src="${fileUrl}" class="img-fluid" style="max-height: 70vh;" alt="${fileName}" onerror="handlePreviewError(this)">
                `;
            } else if (fileType.includes('pdf')) {
                // PDF preview
                contentContainer.innerHTML = `
                    <iframe src="${fileUrl}" width="100%" height="100%" style="border: none;"></iframe>
                `;
            } else if (fileType.includes('text') || fileType.includes('plain')) {
                // Text file preview - fetch and display content
                fetch(fileUrl)
                    .then(response => response.text())
                    .then(text => {
                        contentContainer.innerHTML = `
                            <div class="text-start p-3" style="max-height: 70vh; overflow-y: auto;">
                                <pre class="bg-light p-3 rounded">${escapeHtml(text)}</pre>
                            </div>
                        `;
                    })
                    .catch(error => {
                        contentContainer.innerHTML = `
                            <div class="unsupported-file">
                                <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                                <h5>Unable to preview file</h5>
                                <p>Please download the file to view its contents.</p>
                                <button class="btn btn-primary mt-2" onclick="downloadFile('${fileUrl}', '${fileName}')">
                                    <i class="fas fa-download me-2"></i>Download File
                                </button>
                            </div>
                        `;
                    });
            } else {
                // Unsupported file type
                contentContainer.innerHTML = `
                    <div class="unsupported-file">
                        <i class="fas fa-file fa-3x text-muted mb-3"></i>
                        <h5>Preview not available</h5>
                        <p>Preview is not supported for this file type.</p>
                        <button class="btn btn-primary mt-2" onclick="downloadFile('${fileUrl}', '${fileName}')">
                            <i class="fas fa-download me-2"></i>Download File
                        </button>
                    </div>
                `;
            }
        }

        // Handle preview errors
function handlePreviewError(imgElement) {
    const container = imgElement.parentElement;
    container.innerHTML = `
        <div class="unsupported-file">
            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
            <h5>Unable to load preview</h5>
            <p>The file may have been moved or deleted.</p>
            <button class="btn btn-primary mt-2" onclick="downloadFile('${currentPreviewFile?.url || ''}', '${currentPreviewFile?.name || 'file'}')">
                <i class="fas fa-download me-2"></i>Download File
            </button>
        </div>
    `;
}

// Download file function
window.downloadFile = function(fileUrl, fileName) {
    if (!fileUrl) {
        alert('Download URL not available');
        return;
    }
    
    try {
        // Create a temporary anchor element to trigger download
        const link = document.createElement('a');
        link.href = fileUrl;
        link.download = fileName || 'download';
        link.target = '_blank';
        
        // Append to body, click, and remove
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Download started');
    } catch (error) {
        console.error('Download error:', error);
        alert('Download failed: ' + error.message);
    }
};

// Enhanced file preview function with better error handling
window.previewFile = function(fileUrl, fileType, fileName, section) {
    currentPreviewFile = {
        url: fileUrl,
        name: fileName,
        type: fileType
    };
    
    const modal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
    const title = document.getElementById('filePreviewTitle');
    const content = document.getElementById('filePreviewContent');
    
    if (title) title.textContent = `Preview: ${fileName}`;
    
    // Show loading
    content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading preview...</span>
            </div>
            <p class="mt-2">Loading preview...</p>
        </div>
    `;
    
    modal.show();
    
    // Load preview based on file type with better error handling
    setTimeout(() => {
        loadFilePreview(fileUrl, fileType, fileName, content);
    }, 500);
};

// Helper function for unsupported files
function showUnsupportedFile(container, message) {
    container.innerHTML = `
        <div class="unsupported-file text-center">
            <i class="fas fa-file fa-3x text-muted mb-3"></i>
            <h5>${message}</h5>
            <p>Please download the file to view its contents.</p>
            <button class="btn btn-primary mt-2" onclick="downloadFile('${currentPreviewFile?.url || ''}', '${currentPreviewFile?.name || 'file'}')">
                <i class="fas fa-download me-2"></i>Download File
            </button>
        </div>
    `;
}

// Handle iframe load
window.handleIframeLoad = function(iframe) {
    console.log('Iframe loaded successfully');
};

// Handle iframe error
window.handleIframeError = function(iframe) {
    const container = iframe.parentElement;
    showUnsupportedFile(container, 'Failed to load document preview');
};
        // Enhanced PWA Service Worker Registration
async function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        try {
            const registration = await navigator.serviceWorker.register('/sw.js');
            console.log('✅ Service Worker registered: ', registration);

            // Check for updates
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                console.log('🔄 Service Worker update found');
                
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        showNotification('New version available! Refresh to update.', 'info');
                    }
                });
            });

            // Track service worker state
            if (registration.waiting) {
                console.log('⏳ Service Worker waiting to activate');
            }
            if (registration.active) {
                console.log('✅ Service Worker active');
            }

        } catch (registrationError) {
            console.log('❌ Service Worker registration failed: ', registrationError);
        }
    } else {
        console.log('❌ Service Worker not supported');
    }
}

// Install Prompt Handling
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    console.log('📱 PWA install prompt available');
    // Prevent the mini-infobar from appearing on mobile
    e.preventDefault();
    // Stash the event so it can be triggered later
    deferredPrompt = e;
    
    // Show custom install button (you can add this to your UI)
    showInstallPromotion();
});

// Show install promotion
function showInstallPromotion() {
    // Create install button if it doesn't exist
    if (!document.getElementById('installButton')) {
        const installButton = document.createElement('button');
        installButton.id = 'installButton';
        installButton.className = 'btn btn-success position-fixed';
        installButton.style.cssText = `
            bottom: 100px;
            right: 20px;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
        `;
        installButton.innerHTML = '<i class="fas fa-download me-2"></i>Install App';
        installButton.onclick = installPWA;
        
        document.body.appendChild(installButton);
        
        // Show button after a delay
        setTimeout(() => {
            installButton.style.display = 'block';
        }, 5000);
    }
}
// ==================== MOBILE BACK NAVIGATION SYSTEM ====================

function setupBackNavigation() {
    console.log('🔙 Setting up back navigation system');
    
    // Handle browser back/forward buttons
    window.addEventListener('popstate', function(event) {
        if (event.state && event.state.section) {
            isBackNavigation = true;
            switchSection(event.state.section, true);
        }
    });
    
    // Add back button to mobile header
    addBackButtonToUI();
}

function addBackButtonToUI() {
    // Create back button for mobile
    const backButton = document.createElement('button');
    backButton.id = 'mobileBackBtn';
    backButton.className = 'btn btn-outline-secondary d-md-none mobile-back-btn';
    backButton.innerHTML = '<i class="fas fa-arrow-left"></i>';
    backButton.style.cssText = `
        position: fixed;
        top: 80px;
        left: 15px;
        z-index: 999;
        display: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
    `;
    backButton.onclick = goBack;
    
    document.body.appendChild(backButton);
}

function goBack() {
    if (navigationHistory.length > 0) {
        const previousSection = navigationHistory.pop();
        console.log('↩️ Going back to:', previousSection);
        isBackNavigation = true;
        switchSection(previousSection, true);
    } else {
        // If no history, go to dashboard
        console.log('🏠 No history, going to dashboard');
        navigationHistory = [];
        switchSection('dashboard');
    }
}

function updateBackButtonVisibility() {
    const backButton = document.getElementById('mobileBackBtn');
    if (!backButton) return;
    
    const isMobile = window.innerWidth < 768;
    const shouldShow = isMobile && navigationHistory.length > 0;
    
    backButton.style.display = shouldShow ? 'flex' : 'none';
    
    // Also handle chat back button
    const chatBackBtn = document.getElementById('chatBackBtn');
    if (chatBackBtn) {
        chatBackBtn.style.display = isMobile ? 'block' : 'none';
    }
}

// Update on window resize
window.addEventListener('resize', updateBackButtonVisibility);

        // ==================== USER PROFILE VIEWING SYSTEM ====================

window.viewUserProfile = async function(userId, userName = null) {
    console.log('👥 Viewing user profile:', userId);
    
    try {
        showProgressOverlay('Loading profile...');
        
        // Fetch user data
        const { data: userData, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', userId)
            .single();
            
        if (error) throw error;
        
        currentViewedUser = userData;
        
        // Create or show user profile section
        showUserProfileSection(userData);
        
        // Load user's contributions
        loadUserContributionsView(userId);
        
    } catch (error) {
        console.error('Error loading user profile:', error);
        showNotification('Error loading user profile', 'error');
        goBack();
    } finally {
        hideProgressOverlay();
    }
};

function showUserProfileSection(userData) {
    // Create user profile section if it doesn't exist
    let userProfileSection = document.getElementById('user-profile');
    
    if (!userProfileSection) {
        userProfileSection = document.createElement('div');
        userProfileSection.id = 'user-profile';
        userProfileSection.className = 'section main-section pt-5 pt-md-3 pb-5';
        userProfileSection.innerHTML = getUserProfileHTML();
        document.querySelector('.container-fluid').appendChild(userProfileSection);
    }
    
    // Update profile data
    updateUserProfileView(userData);
    
    // Switch to user profile section
    switchSection('user-profile');
}

function getUserProfileHTML() {
    return `
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="profile-picture-container">
                                <img src="" alt="Profile Picture" class="profile-picture" id="viewedUserPicture">
                                <div class="user-initials" id="viewedUserInitials"></div>
                            </div>
                            <h4 id="viewedUserName">User Name</h4>
                            <p class="text-muted" id="viewedUserLevel">Level</p>
                            <p class="text-muted" id="viewedUserDepartment">Department</p>
                            <p class="text-muted" id="viewedUserEmail">Email</p>
                            
                            <!-- Message Button -->
                            <button class="btn btn-primary mt-3" id="messageUserBtn">
                                <i class="fas fa-comment me-2"></i>Message
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Contributions</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-4">
                                    <h3 id="viewedUserNotesCount">0</h3>
                                    <p class="text-muted">Notes</p>
                                </div>
                                <div class="col-4">
                                    <h3 id="viewedUserAssignmentsCount">0</h3>
                                    <p class="text-muted">Assignments</p>
                                </div>
                                <div class="col-4">
                                    <h3 id="viewedUserPastQuestionsCount">0</h3>
                                    <p class="text-muted">Past Questions</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User's Recent Notes -->
                    <div class="card mt-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Recent Notes</h5>
                            <a href="#" onclick="viewAllUserItems('notes')" class="btn btn-sm btn-primary">View All</a>
                        </div>
                        <div class="card-body">
                            <div id="viewedUserNotesContent">
                                <div class="loading-spinner">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function updateUserProfileView(userData) {
    // Update basic info
    document.getElementById('viewedUserName').textContent = userData.name;
    document.getElementById('viewedUserLevel').textContent = userData.level;
    document.getElementById('viewedUserDepartment').textContent = userData.department;
    document.getElementById('viewedUserEmail').textContent = userData.email;
    
    // Update profile picture
    const profilePicture = document.getElementById('viewedUserPicture');
    const userInitials = document.getElementById('viewedUserInitials');
    
    if (userData.profile_picture) {
        profilePicture.src = userData.profile_picture;
        profilePicture.style.display = 'block';
        userInitials.style.display = 'none';
    } else {
        profilePicture.style.display = 'none';
        userInitials.style.display = 'flex';
        userInitials.textContent = getInitials(userData.name);
        userInitials.style.backgroundColor = getColorFromName(userData.name);
    }
    
    // Setup message button
    const messageBtn = document.getElementById('messageUserBtn');
    if (messageBtn) {
        messageBtn.onclick = () => messageUser(userData.id, userData.name);
    }
}

async function loadUserContributionsView(userId) {
    try {
        // Get counts
        const [notesCount, assignmentsCount, pastQuestionsCount] = await Promise.all([
            supabase.from('notes').select('*', { count: 'exact', head: true }).eq('user_id', userId),
            supabase.from('assignments').select('*', { count: 'exact', head: true }).eq('user_id', userId),
            supabase.from('past_questions').select('*', { count: 'exact', head: true }).eq('user_id', userId)
        ]);
        
        // Update counts
        document.getElementById('viewedUserNotesCount').textContent = notesCount.count || 0;
        document.getElementById('viewedUserAssignmentsCount').textContent = assignmentsCount.count || 0;
        document.getElementById('viewedUserPastQuestionsCount').textContent = pastQuestionsCount.count || 0;
        
        // Load recent notes
        loadUserRecentNotes(userId);
        
    } catch (error) {
        console.error('Error loading user contributions:', error);
    }
}

async function loadUserRecentNotes(userId) {
    try {
        const { data: notes, error } = await supabase
            .from('notes')
            .select('*')
            .eq('user_id', userId)
            .order('created_at', { ascending: false })
            .limit(5);
            
        if (error) throw error;
        
        const container = document.getElementById('viewedUserNotesContent');
        if (!container) return;
        
        if (!notes || notes.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No notes shared yet</p>';
            return;
        }
        
        container.innerHTML = notes.map(note => `
            <div class="list-item">
                <div class="list-item-title">${escapeHtml(note.title)}</div>
                <div class="list-item-meta">${escapeHtml(note.course)} • ${formatDate(note.created_at)}</div>
                ${note.description ? `<p class="mt-2">${escapeHtml(note.description)}</p>` : ''}
                <div class="list-item-actions mt-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="previewFile('${note.file_url}', '${note.file_type}', '${note.file_name || 'File'}', 'notes')">
                        <i class="fas fa-eye me-1"></i>Preview
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="downloadFile('${note.file_url}', '${note.file_name || 'download'}')">
                        <i class="fas fa-download me-1"></i>Download
                    </button>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading user notes:', error);
        document.getElementById('viewedUserNotesContent').innerHTML = '<p class="text-danger">Error loading notes</p>';
    }
}

function messageUser(userId, userName) {
    console.log('💬 Messaging user:', userName);
    
    // Set current chat user
    currentChatUser = {
        id: userId,
        name: userName,
        level: currentViewedUser?.level || '',
        department: currentViewedUser?.department || ''
    };
    
    // Switch to chat section
    switchSection('chat');
    
    // Select the user in chat
    setTimeout(() => {
        selectChatUser(userId, userName, currentViewedUser?.level || '', currentViewedUser?.department || '');
    }, 500);
}

window.viewAllUserItems = function(type) {
    if (!currentViewedUser) return;
    
    switch (type) {
        case 'notes':
            showNotification(`Showing all ${currentViewedUser.name}'s notes`, 'info');
            break;
    }
};
// Install PWA
async function installPWA() {
    if (!deferredPrompt) {
        showNotification('App installation not available', 'warning');
        return;
    }
    
    try {
        // Show the install prompt
        deferredPrompt.prompt();
        
        // Wait for the user to respond to the prompt
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
            console.log('✅ User accepted the install prompt');
            showNotification('App installed successfully!', 'success');
            
            // Hide the install button
            const installButton = document.getElementById('installButton');
            if (installButton) installButton.style.display = 'none';
        } else {
            console.log('❌ User dismissed the install prompt');
        }
        
        // Clear the saved prompt since it can't be used again
        deferredPrompt = null;
        
    } catch (error) {
        console.error('❌ Install error:', error);
        showNotification('Installation failed', 'error');
    }
}

// Track app installation
window.addEventListener('appinstalled', (evt) => {
    console.log('🏠 CampusNote was installed successfully');
    // You can track installations here
});

// Check if app is running as PWA
function isRunningAsPWA() {
    return window.matchMedia('(display-mode: standalone)').matches || 
           window.navigator.standalone ||
           document.referrer.includes('android-app://');
}

// Initialize PWA features
function initializePWA() {
    console.log('📱 Initializing PWA features');
    
    // Register service worker
    registerServiceWorker();
    
    // Check if running as PWA
    if (isRunningAsPWA()) {
        console.log('🏠 Running as installed PWA');
        document.body.classList.add('pwa-mode');
        
        // Add PWA-specific enhancements
        enhanceForPWA();
    } else {
        console.log('🌐 Running in browser');
    }
}

// Enhance UI for PWA
function enhanceForPWA() {
    // Hide browser UI elements that aren't needed in PWA
    const style = document.createElement('style');
    style.textContent = `
        .pwa-mode .browser-only {
            display: none !important;
        }
        
        /* Add PWA-specific styles */
        @media (display-mode: standalone) {
            body {
                -webkit-user-select: none;
                user-select: none;
            }
        }
    `;
    document.head.appendChild(style);
}

// Network status detection for PWA
function setupNetworkDetection() {
    window.addEventListener('online', () => {
        console.log('🌐 Online - connection restored');
        showNotification('Connection restored', 'success');
        document.body.classList.remove('offline');
    });

    window.addEventListener('offline', () => {
        console.log('📴 Offline - connection lost');
        showNotification('You are currently offline', 'warning');
        document.body.classList.add('offline');
    });

    // Initial check
    if (!navigator.onLine) {
        document.body.classList.add('offline');
        showNotification('You are currently offline', 'warning');
    }
}

// ==================== LOCAL FILE PREVIEW FUNCTIONS ====================
// Preview local file before upload
window.previewLocalFile = function(button) {
    const fileItem = button.closest('.file-preview-item');
    const file = fileItem.dataset.file;
    
    if (!file) {
        alert('File data not available');
        return;
    }

    const fileName = button.getAttribute('data-file-name');
    const fileType = button.getAttribute('data-file-type');
    
    // Create object URL for local file preview
    const fileUrl = URL.createObjectURL(file);
    
    currentPreviewFile = {
        url: fileUrl,
        name: fileName,
        type: fileType,
        isLocal: true
    };
    
    const modal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
    const title = document.getElementById('filePreviewTitle');
    const content = document.getElementById('filePreviewContent');
    
    if (title) title.textContent = `Preview: ${fileName} (Local)`;
    
    // Show loading
    content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading preview...</span>
            </div>
            <p class="mt-2">Loading preview...</p>
        </div>
    `;
    
    modal.show();
    
    // Load preview
    setTimeout(() => {
        loadFilePreview(fileUrl, fileType, fileName, content);
    }, 500);
    
    // Clean up object URL when modal is closed
    const modalElement = document.getElementById('filePreviewModal');
    if (modalElement) {
        modalElement.addEventListener('hidden.bs.modal', function cleanup() {
            if (currentPreviewFile?.isLocal) {
                URL.revokeObjectURL(fileUrl);
            }
            modalElement.removeEventListener('hidden.bs.modal', cleanup);
        });
    }
};
        

// Enhanced remove file function
window.removeFile = function(element, inputId) {
    const fileItem = element.closest('.file-preview-item');
    
    // Revoke object URL if it's a local file preview
    const file = fileItem.dataset.file;
    if (file && file instanceof File) {
        // If we had created an object URL for preview, revoke it
        const previewButtons = fileItem.querySelectorAll('[onclick*="previewLocalFile"]');
        previewButtons.forEach(btn => {
            const fileName = btn.getAttribute('data-file-name');
            // Clean up any object URLs if needed
        });
    }
    
    fileItem.remove();
    
    // Clear the file input
    const fileInput = document.getElementById(inputId);
    if (fileInput) {
        fileInput.value = '';
    }
    
    // Update preview container
    const previewContainer = fileItem.parentElement;
    if (previewContainer && previewContainer.children.length === 0) {
        previewContainer.innerHTML = '<p class="text-muted">No files selected</p>';
    }
};
// sw.js - Basic Service Worker
self.addEventListener('install', (event) => {
    console.log('Service Worker installed');
    self.skipWaiting();
});

self.addEventListener('activate', (event) => {
    console.log('Service Worker activated');
});

self.addEventListener('fetch', (event) => {
    // Basic fetch handling
    event.respondWith(fetch(event.request));
});
</script>
</body>
</html>
